<!DOCTYPE html>
<!-- saved from url=(0460)http://cache.baiducontent.com/c?m=9f65cb4a8c8507ed19fa950d100b92235c4380146d8b804b2281d25f93130a1c187bb2f17c78571991d8766105a84e57ece736056d457fe98f8dd50a8bb4cc6f7c9f2644245cd51e459644ef925125b037e129fedf1ef0ccf725e3d8&p=9b759a46d68204f213a5c7710f47&newp=8b2a975986cc42af00b1d627444992695d0fc20e3cd6d101298ffe0cc4241a1a1a3aecbf2324160ed8c57c6702aa4e5beef03573320634f1f689df08d2ecce7e33&user=baidu&fm=sc&query=LuaFramework+%CA%B5%D5%BD&qid=e9a2d87c0003b514&p1=3 -->
<html lang="zh-cn"><head><meta http-equiv="Content-Type" content="text/html; charset=GBK">
<!--<base href="https://www.cnblogs.com/cxihu/p/8465594.html">--><base href=".">
<style>
body{position:relative}
body,form{margin:0!important;padding:0!important}
#bd_snap{font:13px arial;color:#000;background:#fff;text-align:left;padding:13px 0 0 20px}
#bd_snap_txt{clear:both;padding:10px 0 2px;line-height:24px;color:#333}
#bd_snap_note{color:#999;padding-bottom:10px}
#bd_snap a{font:13px arial;color:#00c;text-decoration:underline}
#bd_snap_note a{color:#999}
#bd_snap_head{width:860px;height:44px}
#bd_snap_logo{width:162px;height:38px;display:block;background:url(http://www.baidu.com/img/logo-snap.png) no-repeat;margin-right:15px;float:left}
#bd_snap_search{width:680px;position:absolute;left:209px;top:17px}
#bd_snap_kw{width:531px;margin-right: 0;height:24px;padding:4px 7px;padding:6px 7px 2px\9;font:16px arial;vertical-align:top;border: 1px solid #b6b6b6;border-color: #7b7b7b #b6b6b6 #b6b6b6 #7b7b7b;background: #fff;display:inline-block;border-right-width: 0;border-color: #b8b8b8 transparent #ccc #b8b8b8;overflow: hidden;outline:0}
#bd_snap_kw:hover{border-color: #999 transparent #b3b3b3 #999;}
#bd_snap_kw:focus{border-color: #4791ff transparent #4791ff #4791ff}
#bd_snap_su{width:100px;height:34px;font-size:14px;color:#fff;padding:0;letter-spacing: 1px;background: #3385ff; border-bottom: 1px solid #2d78f4;outline: medium;-webkit-appearance: none;-webkit-border-radius: 0;cursor:pointer;border:0}
#bd_snap_search input.bd_snap_btn_h{background: #3075dc;box-shadow: inset 1px 1px 3px #2964bb;-webkit-box-shadow: inset 1px 1px 3px #2964bb;-moz-box-shadow: inset 1px 1px 3px #2964bb;-o-box-shadow: inset 1px 1px 3px #2964bb;}
#bd_snap_search input.btnhover{background: #317ef3;border-bottom: 1px solid #2868c8;box-shadow: 1px 1px 1px #ccc;}
#bd_snap_btn_wr{width:97px;height:34px;display:inline-block;_top:1px;*position:relative}
#bd_snap_ln{height:1px;border-top:1px solid #ACA899;background:#ECE9D8;overflow:hidden}
#bd_snap_txt span a{text-decoration:none}
</style>


</head><body><div id="bd_snap">
    <div id="bd_snap_head">
        <a href="http://www.baidu.com/" id="bd_snap_logo" title="到百度首页"></a>
    </div>
    <div id="bd_snap_txt">您查询的关键词是：<span><a style="color:black;background-color:#ffff66;padding:0 3px;font-weight:bold" href="http://cache.baiducontent.com/c?m=9f65cb4a8c8507ed19fa950d100b92235c4380146d8b804b2281d25f93130a1c187bb2f17c78571991d8766105a84e57ece736056d457fe98f8dd50a8bb4cc6f7c9f2644245cd51e459644ef925125b037e129fedf1ef0ccf725e3d8&amp;p=9b759a46d68204f213a5c7710f47&amp;newp=8b2a975986cc42af00b1d627444992695d0fc20e3cd6d101298ffe0cc4241a1a1a3aecbf2324160ed8c57c6702aa4e5beef03573320634f1f689df08d2ecce7e33&amp;user=baidu&amp;fm=sc&amp;query=LuaFramework+%CA%B5%D5%BD&amp;qid=e9a2d87c0003b514&amp;p1=3#baidusnap0">lua</a><a style="color:black;background-color:#99ff99;padding:0 3px;font-weight:bold" href="http://cache.baiducontent.com/c?m=9f65cb4a8c8507ed19fa950d100b92235c4380146d8b804b2281d25f93130a1c187bb2f17c78571991d8766105a84e57ece736056d457fe98f8dd50a8bb4cc6f7c9f2644245cd51e459644ef925125b037e129fedf1ef0ccf725e3d8&amp;p=9b759a46d68204f213a5c7710f47&amp;newp=8b2a975986cc42af00b1d627444992695d0fc20e3cd6d101298ffe0cc4241a1a1a3aecbf2324160ed8c57c6702aa4e5beef03573320634f1f689df08d2ecce7e33&amp;user=baidu&amp;fm=sc&amp;query=LuaFramework+%CA%B5%D5%BD&amp;qid=e9a2d87c0003b514&amp;p1=3#baidusnap2">实战</a></span>  <span style="margin-left:5px">以下是该网页在北京时间 2018年12月20日 23:36:31 的快照；</span>
        <p>如果打开速度慢，可以尝试<a href="http://cache.baiducontent.com/c?m=9f65cb4a8c8507ed19fa950d100b92235c4380146d8b804b2281d25f93130a1c187bb2f17c78571991d8766105a84e57ece736056d457fe98f8dd50a8bb4cc6f7c9f2644245cd51e459644ef925125b037e129fedf1ef0ccf725e3d8&amp;p=9b759a46d68204f213a5c7710f47&amp;newp=8b2a975986cc42af00b1d627444992695d0fc20e3cd6d101298ffe0cc4241a1a1a3aecbf2324160ed8c57c6702aa4e5beef03573320634f1f689df08d2ecce7e33&amp;user=baidu&amp;fm=sc&amp;query=LuaFramework+%CA%B5%D5%BD&amp;qid=e9a2d87c0003b514&amp;p1=3&amp;fast=y">快速版</a>；如果想更新或删除快照，可以<a href="http://help.baidu.com/newadd?prod_id=1&amp;category=1&amp;link=http%3A%2F%2Fcache.baiducontent.com%2Fc%3Fm%3D9f65cb4a8c8507ed19fa950d100b92235c4380146d8b804b2281d25f93130a1c187bb2f17c78571991d8766105a84e57ece736056d457fe98f8dd50a8bb4cc6f7c9f2644245cd51e459644ef925125b037e129fedf1ef0ccf725e3d8%26p%3D9b759a46d68204f213a5c7710f47%26newp%3D8b2a975986cc42af00b1d627444992695d0fc20e3cd6d101298ffe0cc4241a1a1a3aecbf2324160ed8c57c6702aa4e5beef03573320634f1f689df08d2ecce7e33%26user%3Dbaidu%26fm%3Dsc%26query%3DLuaFramework%2B%25CA%25B5%25D5%25BD%26qid%3De9a2d87c0003b514%26p1%3D3" id="bd_tousu">投诉快照</a>。
        </p>
    </div>
<script>document.getElementById('bd_tousu').href = 'http://help.baidu.com/newadd?prod_id=1&category=1&link=' + encodeURIComponent(document.location);</script>
    <div id="bd_snap_note">百度和网页 <a href="https://www.cnblogs.com/cxihu/p/8465594.html">https://www.cnblogs.com/cxihu/p/8465594.html</a> 的作者无关，不对其内容负责。百度快照谨为网络故障时之索引，不代表被搜索网站的即时页面。</div>
</div>
<div id="bd_snap_search">
	<form action="http://www.baidu.com/s"><input name="cl" type="hidden" value="3"><input name="wd" id="bd_snap_kw" maxlength="100"><span id="bd_snap_btn_wr"><input type="submit" id="bd_snap_su" value="百度一下" class="bd_snap_btn" onmouseover="this.className=&#39;bd_snap_btn bd_snap_btn_h&#39;" onmousedown="this.className=&#39;bd_snap_btn btnhover&#39;" onmouseup="this.className=&#39;bd_snap_btn&#39;" onmouseout="this.className=&#39;bd_snap_btn&#39;"></span></form>
</div>
<div id="bd_snap_ln"></div>
<div style="position:relative">





<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="referrer" content="never">
<title>LuaFramework 实战 - 田树东 - 博客园</title>
<meta property="og:description" content="本文转载自 ：碧俐千仞的博客http://blog.sina.com.cn/peiyul1、安装框架只要在http://www.ulua.org/index.html下载LuaFramework，..">
<link type="text/css" rel="stylesheet" href="./LuaFramework 实战 - 田树东 - 博客园_files/blog-common.css">
<link id="MainCss" type="text/css" rel="stylesheet" href="./LuaFramework 实战 - 田树东 - 博客园_files/bundle-darkgreentrip.css">
<link id="mobile-style" media="only screen and (max-width: 767px)" type="text/css" rel="stylesheet" href="./LuaFramework 实战 - 田树东 - 博客园_files/bundle-darkgreentrip-mobile.css">
<link title="RSS" type="application/rss+xml" rel="alternate" href="https://www.cnblogs.com/cxihu/rss">
<link title="RSD" type="application/rsd+xml" rel="EditURI" href="https://www.cnblogs.com/cxihu/rsd.xml">
<link type="application/wlwmanifest+xml" rel="wlwmanifest" href="https://www.cnblogs.com/cxihu/wlwmanifest.xml">






<a name="top"></a>

<!--done-->
<div id="home">
<div id="header">
	<div id="blogTitle">
	<a id="lnkBlogLogo" href="https://www.cnblogs.com/cxihu/"><img id="blogLogo" src="./LuaFramework 实战 - 田树东 - 博客园_files/logo.gif" alt="返回主页"></a>			
		
<!--done-->
<h1><a id="Header1_HeaderTitle" class="headermaintitle" href="https://www.cnblogs.com/cxihu/">Cxihu田树东的游戏开发博客</a></h1>
<h2>图灵的光环/ 编程的派宗/卡马克的像素/浅色的床单</h2>



		
	</div><!--end: blogTitle 博客的标题和副标题 -->
	<div id="navigator">
		
<ul id="navList">
<li><a id="blog_nav_sitehome" class="menu" href="https://www.cnblogs.com/">博客园</a></li>
<li><a id="blog_nav_myhome" class="menu" href="https://www.cnblogs.com/cxihu/">首页</a></li>
<li><a id="blog_nav_newpost" class="menu" rel="nofollow" href="https://i.cnblogs.com/EditPosts.aspx?opt=1">新随笔</a></li>
<li><a id="blog_nav_contact" class="menu" rel="nofollow" href="https://msg.cnblogs.com/send/%E7%94%B0%E6%A0%91%E4%B8%9C">联系</a></li>
<li><a id="blog_nav_rss" class="menu" href="https://www.cnblogs.com/cxihu/rss">订阅</a>
<!--<a id="blog_nav_rss_image" class="aHeaderXML" href="https://www.cnblogs.com/cxihu/rss"><img src="//www.cnblogs.com/images/xml.gif" alt="订阅" /></a>--></li>
<li><a id="blog_nav_admin" class="menu" rel="nofollow" href="https://i.cnblogs.com/">管理</a></li>
</ul>
		<div class="blogStats">
			
			
			
		</div><!--end: blogStats -->
	</div><!--end: navigator 博客导航栏 -->
</div><!--end: header 头部 -->

<div id="main">
	<div id="mainContent">
	<div class="forFlow">
		
<div id="post_detail">
<!--done-->
<div id="topics">
	<div class="post">
		<h1 class="postTitle">
			<a name="baidusnap2"></a><a id="cb_post_title_url" class="postTitle2" href="https://www.cnblogs.com/cxihu/p/8465594.html">LuaFramework <b style="color:black;background-color:#99ff99">实战</b></a>
		</h1>
		<div class="clear"></div>
		<div class="postBody">
			<div id="cnblogs_post_body" class="blogpost-body">
                            <div class="htmledit_views">
                        
<h1 style="margin: 0px 0px 16px; padding: 0px; line-height: 50px; font-family: &quot;Microsoft Yahei&quot;, Simsun">
<span style="font-size: 12px; color: rgb(51,51,51); font-weight: 400">本文转载自 ：</span><span style="font-weight: normal; background-color: rgb(255,255,255)"><span style="color: #663300"><span style="font-family: 微软雅黑, 黑体; font-size: 12px; text-decoration: none">碧俐千仞的博客</span><span style="font-family: Verdana, 宋体, sans-serif; font-size: 12px; text-decoration: none">http://blog.sina.com.cn/peiyul</span></span></span></h1>
<h1 style="margin: 0px 0px 16px; padding: 0px; font-size: 34px; font-weight: 400; line-height: 50px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun">
1、安装框架</h1>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
只要在http://www.ulua.org/index.html下载LuaFramework，然后用Unity3D打开，这里用的是LuaFramework_UGUI-1.0.4.109版本以及Unity3D 5.2，其他版本理应相似。打开之后需要点击<a name="baidusnap0"></a><b style="color:black;background-color:#ffff66">lua</b>菜单里面的Generate All和LuaFramework菜单里Build XXX Resources，以生成一些必要的文件。</p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
安装过程可以参见http://pan.baidu.com/s/1gd8fG4N里面的01_uLua_Windows.avi和02_SimpleFramework_UGUI_Windows.avi两个视频（如果在windows系统下）。框架结构请参见http://doc.ulua.org/article/ngui/simpleframework_base1.html，这里不再复述。</p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
若运行后能够弹出示范界面，证明安装成功，可以进入下一步。</p>
<div style="color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px; line-height: 28px; padding-top: 5px">
<div style="overflow: hidden; text-align: center; padding: 0px 0px 34px; position: relative">
<span style="color: #999999"><span style="vertical-align: middle; max-width: 100%"><img src="./LuaFramework 实战 - 田树东 - 博客园_files/001TylVCgy72CSuYuDUe2" alt="" title="" style="border: 0px; vertical-align: middle; max-width: 100%"></span></span><span style="color: rgb(153,153,153); display: block; padding: 5px 7px 0px; font-size: 14px; line-height: 20px; outline: none"><em>&#65533;1&#65533;3成功运行示范界面（可要客户端能够运行起来就行）</em></span><span style="color: #999999"><span>&nbsp;</span></span></div>
</div>
<h1 style="margin: 0px 0px 16px; padding: 0px; font-size: 34px; font-weight: 400; line-height: 50px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun">
&#65533;6&#65533;72、运行<b style="color:black;background-color:#ffff66">Lua</b>代码</h1>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
这一步的目标很简单，就是让框架运行我们自己写的<b style="color:black;background-color:#ffff66">lua</b>代码，显示一句“helloWorld”。下一步再考虑代码的热更新问题。</p>
<h2 style="margin: 0px 0px 18px; padding: 0px; font-size: 24px; font-weight: 400; line-height: 38px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun">
1）新建场景</h2>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
在任意物体中添加Main组件。其实Main组件里面只是调用了AppFacade.Instance.StartUp()，这是框架的起点。框架将会自动完成资源加载、热更新等等事项。</p>
<div style="color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px; line-height: 28px; padding-top: 5px">
<div style="overflow: hidden; text-align: center; padding: 0px 0px 34px; position: relative">
<span style="color: #999999"><span style="vertical-align: middle; max-width: 100%"><img src="./LuaFramework 实战 - 田树东 - 博客园_files/001TylVCgy72CSAtZOz4b" alt="" title="" style="border: 0px; vertical-align: middle; max-width: 100%"></span></span><span style="color: rgb(153,153,153); display: block; padding: 5px 7px 0px; font-size: 14px; line-height: 20px; outline: none"><em>&#65533;1&#65533;3添加Main组件</em></span></div>
</div>
<h2 style="margin: 0px 0px 18px; padding: 0px; font-size: 24px; font-weight: 400; line-height: 38px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun">
2）删掉示例的调用</h2>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
现在不需要框架自带的示例了，需要删掉一些代码，使框架只运行我们编写的<b style="color:black;background-color:#ffff66">lua</b>文件。打开Assets\LuaFramework\Scripts\Manager\GameManager.cs，将OnInitalize修改成下图这个样子。这是<b style="color:black;background-color:#ffff66">lua</b>的入口，框架会调用Main.<b style="color:black;background-color:#ffff66">lua</b>的Main方法。</p>
<div style="color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px; line-height: 28px; padding-top: 5px">
<div style="overflow: hidden; text-align: center; padding: 0px 0px 34px; position: relative">
<span style="color: #999999"><span style="vertical-align: middle; max-width: 100%"><img src="./LuaFramework 实战 - 田树东 - 博客园_files/001TylVCty72DxKlKJy98" alt="" title="" style="border: 0px; vertical-align: middle; max-width: 100%"></span></span><span style="color: rgb(153,153,153); display: block; padding: 5px 7px 0px; font-size: 14px; line-height: 20px; outline: none"><em>&#65533;1&#65533;3修改GameManager的<b style="color:black;background-color:#ffff66">lua</b>入口</em></span></div>
</div>
<h2 style="margin: 0px 0px 18px; padding: 0px; font-size: 24px; font-weight: 400; line-height: 38px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun">
3）编写<b style="color:black;background-color:#ffff66">lua</b>代码</h2>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
打开Assets\LuaFramework\<b style="color:black;background-color:#ffff66">Lua</b>\main.<b style="color:black;background-color:#ffff66">lua</b>，编写<b style="color:black;background-color:#ffff66">lua</b>代码。这里只添加一句“LuaFramework.Util.Log("HelloWorld");”（如下所示），它的功能相当于Debug.Log("HelloWorld")。</p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(85,164,85)"><em>--主入口函数。从这里开始<b style="color:black;background-color:#ffff66">lua</b>逻辑</em></span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<em><span style="color: rgb(204,0,0)">function Main()</span></em></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(204,0,0); word-spacing: normal"><em>&nbsp; &nbsp; LuaFramework<span style="word-spacing: normal">.Util.Log("HelloWorld");</span></em></span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<em><span style="color: rgb(204,0,0)">end</span></em></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
“LuaFramework.Util.Log("HelloWorld")”中的Util是c#里定义的类，供<b style="color:black;background-color:#ffff66">lua</b>中调用。可以打开Assets\LuaFramework\Editor\CustomSettings.cs看到所有可以供<b style="color:black;background-color:#ffff66">lua</b>调用的类，如下图是CustomSettings.cs的部分语句。</p>
<div style="color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px; line-height: 28px; padding-top: 5px">
<div style="overflow: hidden; text-align: center; padding: 0px 0px 34px; position: relative">
<span style="color: #999999"><span style="vertical-align: middle; max-width: 100%"><img src="./LuaFramework 实战 - 田树东 - 博客园_files/001TylVCgy72CT0AlAXc7" alt="" title="" style="border: 0px; vertical-align: middle; max-width: 100%"></span></span><span style="color: rgb(153,153,153); display: block; padding: 5px 7px 0px; font-size: 14px; line-height: 20px; outline: none"><em>CustomSettings.cs的部分语句&#65533;1&#65533;3</em></span><span style="color: #999999"><span>&nbsp;</span></span></div>
</div>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
再由具体的类可以查找所有的API（参见下面两个图），如下图是Util类的部分语句。</p>
<div style="color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px; line-height: 28px; padding-top: 5px">
<div style="overflow: hidden; text-align: center; padding: 0px 0px 34px; position: relative">
<span style="color: #999999"><span style="vertical-align: middle; max-width: 100%"><img src="./LuaFramework 实战 - 田树东 - 博客园_files/001TylVCgy72CT2etnE7e" alt="" title="" style="border: 0px; vertical-align: middle; max-width: 100%"></span></span><span style="color: rgb(153,153,153); display: block; padding: 5px 7px 0px; font-size: 14px; line-height: 20px; outline: none"><em>&#65533;1&#65533;3Util类（Assets\LuaFramework\Scripts\Utility\Util.cs）的部分语句</em></span><span style="color: #999999"><span>&nbsp;</span></span></div>
</div>
<h2 style="margin: 0px 0px 18px; padding: 0px; font-size: 24px; font-weight: 400; line-height: 38px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun">
4）运行游戏</h2>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
点击菜单栏中LuaFramework→Build Windows Resource，生成资源文件。然后运行游戏，即可在控制台中看到打印出的HelloWorld。</p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
&nbsp;</p>
<div style="color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px; line-height: 28px; padding-top: 5px">
<div style="overflow: hidden; text-align: center; padding: 0px 0px 34px; position: relative">
<span style="color: #999999"><span style="vertical-align: middle; max-width: 100%"><img src="./LuaFramework 实战 - 田树东 - 博客园_files/001TylVCgy72CT4VBy3eb" alt="" title="" style="border: 0px; vertical-align: middle; max-width: 100%"></span></span><span style="color: rgb(153,153,153); display: block; padding: 5px 7px 0px; font-size: 14px; line-height: 20px; outline: none"><em>&#65533;1&#65533;3生成资源文件</em></span></div>
</div>
<div style="color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px; line-height: 28px; padding-top: 5px">
<div style="overflow: hidden; text-align: center; padding: 0px 0px 34px; position: relative">
<span style="color: #999999"><span style="vertical-align: middle; max-width: 100%"><img src="./LuaFramework 实战 - 田树东 - 博客园_files/001TylVCgy72CT8yLzb51" alt="" title="" style="border: 0px; vertical-align: middle; max-width: 100%"></span></span><span style="color: rgb(153,153,153); display: block; padding: 5px 7px 0px; font-size: 14px; line-height: 20px; outline: none"><em>&#65533;1&#65533;3运行结果</em></span><span style="color: #999999"><span>&nbsp;</span></span></div>
</div>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
按照默认的设置，每更改一次<b style="color:black;background-color:#ffff66">lua</b>代码，都需要执行Build XXX Resource才能生效。读者可以将Assets\LuaFramework\Scripts\ConstDefine\AppConst.cs中的LuaBundleMode修改为false，这样代码文件便不会以AssetBundle模式读取，会直接生效，以方便调试。</p>
<div style="color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px; line-height: 28px; padding-top: 5px">
<div style="overflow: hidden; text-align: center; padding: 0px 0px 34px; position: relative">
<span style="color: #999999"><span style="vertical-align: middle; max-width: 100%"><img src="./LuaFramework 实战 - 田树东 - 博客园_files/001TylVCgy72CTapHz7a5" alt="" title="" style="border: 0px; vertical-align: middle; max-width: 100%"></span></span><span style="color: rgb(153,153,153); display: block; padding: 5px 7px 0px; font-size: 14px; line-height: 20px; outline: none"><em>&#65533;1&#65533;3设置LuaBundleMode</em></span></div>
</div>
<h1 style="margin: 0px 0px 16px; padding: 0px; font-size: 34px; font-weight: 400; line-height: 50px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun">
3、热更新的原理</h1>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
接下来便要尝试代码热更新，让程序下载服务器上的<b style="color:black;background-color:#ffff66">lua</b>文件，然后运行它。在说明热更新之前，需要先看看Unity3D热更新的一般方法。如下图所示，Unity3D的热更新会涉及3个目录。</p>
<div style="color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px; line-height: 28px; padding-top: 5px">
<div style="overflow: hidden; text-align: center; padding: 0px 0px 34px; position: relative">
<span style="color: #999999"><span style="vertical-align: middle; max-width: 100%"><img src="./LuaFramework 实战 - 田树东 - 博客园_files/001TylVCgy72CTpP0nR5f" alt="" title="" style="border: 0px; vertical-align: middle; max-width: 100%"></span></span><span style="color: rgb(153,153,153); display: block; padding: 5px 7px 0px; font-size: 14px; line-height: 20px; outline: none"><em>&#65533;1&#65533;3热更新的过程</em></span></div>
</div>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<strong>游戏资源目录</strong>：里面包含Unity3D工程中StreamingAssets文件夹下的文件。安装游戏之后，这些文件将会被一字不差地复制到目标机器上的特定文件夹里，不同平台的文件夹不同，如下所示（上图以windows平台为例）</p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="word-spacing: normal"><span style="color: rgb(51,152,204)"><em>Mac OS或Windows<span style="word-spacing: normal">：</span><span style="word-spacing: normal">Application.dataPath + "/StreamingAssets";</span></em></span></span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="word-spacing: normal"><span style="color: rgb(51,152,204)"><em>IOS<span style="word-spacing: normal">：</span>&nbsp;<span style="word-spacing: normal">Application.dataPath + "/Raw";</span></em></span></span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="word-spacing: normal"><span style="color: rgb(51,152,204)"><em>Android<span style="word-spacing: normal">：</span><span style="word-spacing: normal">jar:file://" + Application.dataPath + "!/assets/";</span></em></span></span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="word-spacing: normal">&#65533;6&#65533;7</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<strong>数据目录</strong>：由于“游戏资源目录”在Android和IOS上<span style="word-spacing: normal">是只读的，不能把网上的下载的资源放到里面，所以需要建立一个“数据目录”，该目录可读可写。第一次开启游戏后，程序将“游戏资源目录”的内容复制到“数据目录中”（步骤</span><span style="word-spacing: normal">1</span><span style="word-spacing: normal">，这个步骤只会执行一次，下次再打开游戏就不复制了）。游戏过程中的资源加载，都</span><span style="word-spacing: normal">是从“数据目录”中获取、解包（步骤</span><span style="word-spacing: normal">3</span><span style="word-spacing: normal">）。不同平台下，“数据目录”的地址也不同，</span><span style="word-spacing: normal">LuaFramework</span><span style="word-spacing: normal">的定义如下：</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="word-spacing: normal; color: rgb(51,152,204)"><em>Android或IOS：Application.persistentDataPath + "/LuaFramework" &nbsp; &nbsp;</em></span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(51,152,204)"><em>Mac OS或Windows：c:/LuaFramework/</em></span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="word-spacing: normal; color: rgb(51,152,204)"><em>调试模式下：Application.dataPath + "/StreamingAssets/"</em></span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
注：”LuaFramework”和”StreamingAssets”由配置决定，这里取默认值</p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
&nbsp;</p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<strong>网络资源地址</strong>：存放游戏资源的网址，游戏开启后，程序会从网络资源地址下载一些更新的文件到数据目录。</p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
&nbsp;</p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
这些目录包含着不同版本的资源文件，以及用于版本控制的files.txt。Files.txt的内容如下图所示，里面存放着资源文件的名称和md5码。程序会先下载“网络资源地址”上的files.txt，然后与“数据目录”中文件的md5码做比较，更新有变化的文件（步骤2）。</p>
<div style="color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px; line-height: 28px; padding-top: 5px">
<div style="overflow: hidden; text-align: center; padding: 0px 0px 34px; position: relative">
<span style="color: #999999"><span style="vertical-align: middle; max-width: 100%"><img src="./LuaFramework 实战 - 田树东 - 博客园_files/001TylVCgy72CTzIKFy38" alt="" title="" style="border: 0px; vertical-align: middle; max-width: 100%"></span></span><span style="color: rgb(153,153,153); display: block; padding: 5px 7px 0px; font-size: 14px; line-height: 20px; outline: none"><em>&#65533;1&#65533;3files.txt</em></span></div>
</div>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
LuaFramework的热更新代码定义在Assets\LuaFramework\Scripts\Manager\GameManager.cs，真正用到项目时可能还需少许改动。</p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<br>
</p>
<h1 style="margin: 0px 0px 16px; padding: 0px; font-size: 34px; font-weight: 400; line-height: 50px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun">
4、开始热更新代码吧！</h1>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
那么开始测试热更新代码的功能吧！热更上述实现的“HelloWorld”。</p>
<h2 style="margin: 0px 0px 18px; padding: 0px; font-size: 24px; font-weight: 400; line-height: 38px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun">
1）修改配置</h2>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
框架的默认配置是从本地加载文件，需要打开AppConst.cs将UpdateMode设置为true（才会执行步骤2），将LuaBundleMode设置为true，将WebUrl设置成服务器地址。如下图所示。</p>
<div style="color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px; line-height: 28px; padding-top: 5px">
<div style="overflow: hidden; text-align: center; padding: 0px 0px 34px; position: relative">
<span style="color: #999999"><span style="vertical-align: middle; max-width: 100%"><img src="./LuaFramework 实战 - 田树东 - 博客园_files/001TylVCgy72CTLN2mp7d" alt="" title="" style="border: 0px; vertical-align: middle; max-width: 100%"></span></span><span style="color: rgb(153,153,153); display: block; padding: 5px 7px 0px; font-size: 14px; line-height: 20px; outline: none"><em>&#65533;1&#65533;3AppConst的配置</em></span></div>
</div>
<h2 style="margin: 0px 0px 18px; padding: 0px; font-size: 24px; font-weight: 400; line-height: 38px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun">
2）配置“网络资源”</h2>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
笔者使用iis开启本地服务器，然后将StreamingAssets里面的所有内容复制到服务器上面。必要时要配置一些权限，让所有文件都都可以下载。</p>
<div style="color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px; line-height: 28px; padding-top: 5px">
<div style="overflow: hidden; text-align: center; padding: 0px 0px 34px; position: relative">
<span style="color: #999999"><span style="vertical-align: middle; max-width: 100%"><img src="./LuaFramework 实战 - 田树东 - 博客园_files/001TylVCgy72CTOu1M377" alt="" title="" style="border: 0px; vertical-align: middle; max-width: 100%"></span></span><span style="color: rgb(153,153,153); display: block; padding: 5px 7px 0px; font-size: 14px; line-height: 20px; outline: none"><em>&#65533;1&#65533;3通过网络访问文件</em></span></div>
</div>
<h2 style="margin: 0px 0px 18px; padding: 0px; font-size: 24px; font-weight: 400; line-height: 38px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun">
3）测试热更新</h2>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
改一下<b style="color:black;background-color:#ffff66">Lua</b>脚本（如将HelloWorld改为Hello Lpy2），点击Build Windows Resource，将“工程目录/StreamingAssets”里面的文件复制到服务器上。再将脚本改成其他内容，然后Build Windows Resource，覆盖掉本地资源。运行游戏，如果程序显示“Hello Lpy2”的代码，证明成功从网上拉取了文件。</p>
<div style="color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px; line-height: 28px; padding-top: 5px">
<div style="overflow: hidden; text-align: center; padding: 0px 0px 34px; position: relative">
<span style="color: #999999"><span style="vertical-align: middle; max-width: 100%"><img src="./LuaFramework 实战 - 田树东 - 博客园_files/001TylVCgy72CTQjmLJ2f" alt="" title="" style="border: 0px; vertical-align: middle; max-width: 100%"></span></span><span style="color: rgb(153,153,153); display: block; padding: 5px 7px 0px; font-size: 14px; line-height: 20px; outline: none"><em>&#65533;1&#65533;3代码热更新</em></span></div>
</div>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
&nbsp;</p>
<div class="BNE_title" style="border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: rgb(238,238,238); color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun">
<h1 class="h1_tit" id="t_6788cd880102w9jg" style="margin: 0px; padding: 0px; font-size: 34px; font-weight: 400; line-height: 50px; word-spacing: normal">
<br>
</h1>
</div>
<div class="BNE_cont" id="sina_keyword_ad_area2" style="width: 670px; min-height: 230px; font-size: 17px; line-height: 28px; margin-top: 20px; overflow: hidden; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun">
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="word-spacing: normal">热更新涉及资源热更新和代码热更新（其实<b style="color:black;background-color:#ffff66">lua</b>代码也是资源），那接下来看看如何动态加载一个模型，然后热更成其他素材。这一部分涉及资源打包、动态创建资源等内容。</span><br>
</p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="font-size: 24px">1、创建物体</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
为了调试的方便，笔者先将框架配置为本地模式，待测试热更新时再改成更新模式。</p>
<div style="line-height: 28px; padding-top: 5px">
<div style="overflow: hidden; text-align: center; padding: 0px 0px 34px; position: relative">
<span style="color: #999999"><span style="vertical-align: middle; max-width: 100%"><img src="./LuaFramework 实战 - 田树东 - 博客园_files/001TylVCzy72QaujhnC04" alt="" title="" style="border: 0px; vertical-align: middle; max-width: 100%"></span></span><span style="color: rgb(153,153,153); display: block; padding: 5px 7px 0px; font-size: 14px; line-height: 20px; outline: none"><em>&#65533;1&#65533;3配置为本地模式</em></span></div>
</div>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<br>
</p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
先测试个简单的创建物体，新建一个名为go的物体，然后设置它的坐标为(1,1,1)。这段代码虽然不涉及资源加载，但能展示“把物体添加到场景中”的过程。Main.<b style="color:black;background-color:#ffff66">lua</b>的代码如下：</p>
<pre style="margin-top: 0px; margin-bottom: 0px; padding: 0px"><code>function Main()                                    
        local go = UnityEngine.GameObject ('go')
        go.transform.position = Vector3.one             </code>


<code>end</code>

<code>
</code>
</pre>
<div style="line-height: 28px; padding-top: 5px">
<div style="overflow: hidden; text-align: center; padding: 0px 0px 34px; position: relative">
<span style="color: #999999"><span style="vertical-align: middle; max-width: 100%"><img src="./LuaFramework 实战 - 田树东 - 博客园_files/001TylVCzy72QawCRti7c" alt="" title="" style="border: 0px; vertical-align: middle; max-width: 100%"></span></span><span style="color: rgb(153,153,153); display: block; padding: 5px 7px 0px; font-size: 14px; line-height: 20px; outline: none"><em>&#65533;1&#65533;3动态创建一个名为go的空物体</em></span><span style="color: #999999"><span>&nbsp;</span></span></div>
</div>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
要热更新资源，便需要制作资源。这里制作一个名为tankPrefab的坦克模型预设，然后存到Assets/Tank目录下。接下来对它做打包，然后动态加载。</p>
<div style="line-height: 28px; padding-top: 5px">
<div style="overflow: hidden; text-align: center; padding: 0px 0px 34px; position: relative">
<span style="color: #999999"><span style="vertical-align: middle; max-width: 100%"><img src="./LuaFramework 实战 - 田树东 - 博客园_files/001TylVCzy72Qay2HSla5" alt="" title="" style="border: 0px; vertical-align: middle; max-width: 100%"></span></span><span style="color: rgb(153,153,153); display: block; padding: 5px 7px 0px; font-size: 14px; line-height: 20px; outline: none"><em>&#65533;1&#65533;3坦克预设</em></span><span style="color: #999999"><span>&nbsp;</span></span></div>
</div>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<strong>广告时间</strong>：这个坦克模型是来自笔者即将出版的一本书《Unity3D网络游戏<b style="color:black;background-color:#99ff99">实战</b>》。该书通过一个完整的多人坦克对战实例，详细介绍网络游戏开发过程中涉及到的知识和技巧。书中还介绍了服务端框架、客户端网络模块、UI系统的架构等内容。相信透过本书，读者能够掌握Unity3D网络游戏开发的大部分知识，也能够从框架设计中了解商业游戏的设计思路，感谢大家支持。</p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
&#65533;6&#65533;7</p>
<h2 style="margin: 0px 0px 18px; padding: 0px; font-size: 24px; font-weight: 400; line-height: 38px">
2、资源打包</h2>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
LuaFramework在打包方面并没有做太多的工作，我们需要手动打包。打开Assets/LuaFramework/Editor/Packager.cs，按照示例的写法，加上下面这一行：将Assets/Tank目录下的所有预设（.prefab）打包成名为tank的包。</p>
<div style="line-height: 28px; padding-top: 5px">
<div style="overflow: hidden; text-align: center; padding: 0px 0px 34px; position: relative">
<span style="color: #999999"><span style="vertical-align: middle; max-width: 100%"><img src="./LuaFramework 实战 - 田树东 - 博客园_files/001TylVCzy72Qaz9QTldf" alt="" title="" style="border: 0px; vertical-align: middle; max-width: 100%"></span></span><span style="color: rgb(153,153,153); display: block; padding: 5px 7px 0px; font-size: 14px; line-height: 20px; outline: none"><em>&#65533;1&#65533;3修改打包代码</em></span></div>
</div>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
点击“Build Windows Resource”，即可在StreamingAssets中看到打包好的文件。</p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
如下图所示，Unity3D资源包里面包含多个资源，就像一个压缩文件一样。在动态加载的时候，便需要有加载包文件、或取包中的资源两步操作（框架已经帮我们做好了这部分工作，直接调用API即可）。</p>
<div style="line-height: 28px; padding-top: 5px">
<div style="overflow: hidden; text-align: center; padding: 0px 0px 34px; position: relative">
<span style="color: #999999"><span style="vertical-align: middle; max-width: 100%"><img src="./LuaFramework 实战 - 田树东 - 博客园_files/001TylVCzy72QaDRoMoa0" alt="" title="" style="border: 0px; vertical-align: middle; max-width: 100%"></span></span><span style="color: rgb(153,153,153); display: block; padding: 5px 7px 0px; font-size: 14px; line-height: 20px; outline: none"><em>&#65533;1&#65533;3Unity3D的资源包</em></span></div>
</div>
<h2 style="margin: 0px 0px 18px; padding: 0px; font-size: 24px; font-weight: 400; line-height: 38px">
3、动态加载模型</h2>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
编写如下<b style="color:black;background-color:#ffff66">lua</b>代码（main.<b style="color:black;background-color:#ffff66">lua</b>），使用框架提供的资源管理器（resMgr）加载tank包的TankPrefab文件，加载完成后回调OnLoadFinish方法。在OnLoadFinish中使用Instantiate实例化对象。</p>
<pre style="margin-top: 0px; margin-bottom: 0px; padding: 0px"><code>--主入口函数。从这里开始<b style="color:black;background-color:#ffff66">lua</b>逻辑
function Main()                                 
        LuaHelper = LuaFramework.LuaHelper;
        resMgr = LuaHelper.GetResManager();
        resMgr:LoadPrefab('tank', { 'TankPrefab' }, OnLoadFinish);
end

--加载完成后的回调--
function OnLoadFinish(objs)
        local go = UnityEngine.GameObject.Instantiate(objs[0]);
        LuaFramework.Util.Log("Finish");        
</code>

<code>end</code>

<code>
</code>
</pre>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
完成后运行游戏，即可看到动态加载出来的模型。</p>
<div style="line-height: 28px; padding-top: 5px">
<div style="overflow: hidden; text-align: center; padding: 0px 0px 34px; position: relative">
<span style="color: #999999"><span style="vertical-align: middle; max-width: 100%"><img src="./LuaFramework 实战 - 田树东 - 博客园_files/001TylVCzy72QaF7adp7f" alt="" title="" style="border: 0px; vertical-align: middle; max-width: 100%"></span></span><span style="color: rgb(153,153,153); display: block; padding: 5px 7px 0px; font-size: 14px; line-height: 20px; outline: none"><em>&#65533;1&#65533;3动态加载出来的模型</em></span></div>
</div>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<br>
</p>
<h2 style="margin: 0px 0px 18px; padding: 0px; font-size: 24px; font-weight: 400; line-height: 38px">
4、加载资源的过程</h2>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
只有理解了动态加载，即LoadPrefab的过程，才能算是真正的理解了热更新。LoadPrefab为ResourceManager中定义的方法，在Assets\LuaFramework\Scripts\Manager\ResourceManager.cs中实现，建议配合代码看下面的解释。</p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
LoadPrefab的流程如下所示，先是判定当前是否正在加载该资源包，如果没有则调用OnLoadAsset加载资源包、然后解包获取资源、调用回调函数。</p>
<div style="line-height: 28px; padding-top: 5px">
<div style="overflow: hidden; text-align: center; padding: 0px 0px 34px; position: relative">
<span style="color: #999999"><span style="vertical-align: middle; max-width: 100%"><img src="./LuaFramework 实战 - 田树东 - 博客园_files/001TylVCzy72QdEVa5Wb0" alt="" title="" style="border: 0px; vertical-align: middle; max-width: 100%"></span><span>&nbsp;</span></span><span style="color: rgb(153,153,153); display: block; padding: 5px 7px 0px; font-size: 14px; line-height: 20px; outline: none"><em>&#65533;1&#65533;3LoadPrefab的流程</em></span></div>
</div>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<br>
</p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
ResourceManager类定义了m_AssetBundleManifest、m_Dependencies、m_LoadedAssetBundles、m_LoadRequests这4个变量，只要理解了这几个变量的用途，也就能够理解了资源加载的全过程了。这4个变量的类型如下：</p>
<div style="line-height: 28px; padding-top: 5px">
<div style="overflow: hidden; text-align: center; padding: 0px 0px 34px; position: relative">
<span style="color: #999999"><span style="vertical-align: middle; max-width: 100%"><img src="./LuaFramework 实战 - 田树东 - 博客园_files/001TylVCzy72QaIUWN086" alt="" title="" style="border: 0px; vertical-align: middle; max-width: 100%"></span></span><span style="color: rgb(153,153,153); display: block; padding: 5px 7px 0px; font-size: 14px; line-height: 20px; outline: none"><em>&#65533;1&#65533;3ResourceManager定义的几个变量</em></span></div>
</div>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<br>
</p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<strong>m_AssetBundleManifest</strong></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
理解m_AssetBundleManifest之前，需要先理解Unity3D的依赖打包。前面的tank.unity3D中，坦克的预设、坦克的贴图等资源都被打包到一起，没有依赖关系（只要打包时不给贴图单独打包，Unity3D会自动将预设相关的资源都打包进来）。如下图所示。</p>
<div style="line-height: 28px; padding-top: 5px">
<div style="overflow: hidden; text-align: center; padding: 0px 0px 34px; position: relative">
<span style="color: #999999"><span style="vertical-align: middle; max-width: 100%"><img src="./LuaFramework 实战 - 田树东 - 博客园_files/001TylVCzy72QaKFZzmdc" alt="" title="" style="border: 0px; vertical-align: middle; max-width: 100%"></span></span><span style="color: rgb(153,153,153); display: block; padding: 5px 7px 0px; font-size: 14px; line-height: 20px; outline: none"><em>&#65533;1&#65533;3前面加载坦克制作的资源包</em></span></div>
</div>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
假如有两个坦克预设共用一套贴图，如果像上面那样打包，每个坦克预设各自包含一份贴图，资源会比较大。更好的办法是将公共贴图放到一个包里，每个坦克预设不再包含贴图（如下图）。这种打包方式下，加载TankPrefab前，需要先加载依赖包common.unity3D，坦克预设才能找到贴图。</p>
<div style="line-height: 28px; padding-top: 5px">
<div style="overflow: hidden; text-align: center; padding: 0px 0px 34px; position: relative">
<span style="color: #999999"><span style="vertical-align: middle; max-width: 100%"><img src="./LuaFramework 实战 - 田树东 - 博客园_files/001TylVCzy72QaLJUdY8a" alt="" title="" style="border: 0px; vertical-align: middle; max-width: 100%"></span></span><span style="color: rgb(153,153,153); display: block; padding: 5px 7px 0px; font-size: 14px; line-height: 20px; outline: none"><em>&#65533;1&#65533;3依赖打包</em></span></div>
</div>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
打包后，Unity3D会产生一个名为AssetBundle.manifest的文件（框架会将该文件放在StreamingAssets中），该文件包含所有包的依赖信息。所以在加载资源前需要先加载这个文件，m_AssetBundleManifest便是指向这个包的变量。相关代码如下：</p>
<div style="line-height: 28px; padding-top: 5px">
<div style="overflow: hidden; text-align: center; padding: 0px 0px 34px; position: relative">
<span style="color: #999999"><span style="vertical-align: middle; max-width: 100%"><img src="./LuaFramework 实战 - 田树东 - 博客园_files/001TylVCzy72QaS1hmWea" alt="" title="" style="border: 0px; vertical-align: middle; max-width: 100%"></span></span><span style="color: rgb(153,153,153); display: block; padding: 5px 7px 0px; font-size: 14px; line-height: 20px; outline: none"><em>&#65533;1&#65533;3m_AssetBundleManifest便是指向AssetBundle.manifest的变量</em></span></div>
</div>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
加载这个包后，便可以使用下面的语句获取某个包所依赖的所有包名，然后加载它们。</p>
<pre style="margin-top: 0px; margin-bottom: 0px; padding: 0px"><code>string[] dependencies = m_AssetBundleManifest.GetAllDependencies(包名);</code>
</pre>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
注：更多Unity3D的依赖打包的解释，可以参见这篇文章：</p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: #999999"><span>http://liweizhaolili.blog.163.com/blog/static/16230744201541410275298/</span></span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
&#65533;6&#65533;7</p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<strong>m_LoadedAssetBundles</strong></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
字典类型的m_LoadedAssetBundles保存了所有已经加载资源包。如果某个包已经被加载过，那下次需要用到它时，直接从字典中取出即可，减少重复加载。简化后的代码如下：</p>
<pre style="margin-top: 0px; margin-bottom: 0px; padding: 0px"><code>IEnumerator OnLoadAsset(XXX)
{
      AssetBundleInfo bundle = GetLoadedAssetBundle(XXX);  
      if(!bundle)
            bundle  =  OnLoadAssetBundle(名字);  
      加载资源
      回调函数处理
}</code>
</pre>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
其中GetLoadedAssetBundle方法会判断资源包是否存在于m_LoadedAssetBundles中，并返回资源包。OnLoadAssetBundle为重新加载资源包的方法。</p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
加载资源包后，只需通过 bundle.LoadAssetAsync(资源名,类型)便可加载所需的资源。</p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
&#65533;6&#65533;7</p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<strong>m_Dependencies</strong></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
m_Dependencies记录了所有已加载资源的依赖包，以便在GetLoadedAssetBundle方法中判断资源包是否被完全加载（主体包和所有依赖包都被加载才算完成加载）。简化后的代码如下：</p>
<pre style="margin-top: 0px; margin-bottom: 0px; padding: 0px"><code>IEnumerator OnLoadAssetBundle(包名)
{
      //获取依赖包
      string[] dependencies = m_AssetBundleManifest.GetAllDependencies(abName);
      m_Dependencies.Add(abName, dependencies); //更新依赖表
      //加载依赖包
      for (int i = 0; i &lt; dependencies.Length; i++)
            OnLoadAssetBundle(XXX)  
  //然后加载主体资源
       download = http://WWW.LoadFromCacheOrDownload(包名)
       //更新加载表
       m_LoadedAssetBundles.Add(XXX)
}</code>
</pre>
<pre style="margin-top: 0px; margin-bottom: 0px; padding: 0px"><code>AssetBundleInfo GetLoadedAssetBundle(包名)
 {
       //判断加载表
       AssetBundleInfo bundle = m_LoadedAssetBundles[包名];
       if (bundle == null) return null;
       //判断依赖包
       foreach (string 依赖包名 in m_Dependencies[包名])
       {
              if (m_LoadedAssetBundles[依赖包名]== null) 
                     return null;
       }
       return bundle;
</code>

<code>}</code>

<code>
</code>
</pre>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<strong>m_LoadRequests</strong></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
m_LoadRequests是一个&gt;类型的字典，LoadAssetRequest的定义如下，它用于异步加载后的回调。<span style="color: rgb(153,153,153); font-size: 14px; line-height: 20px; text-align: center; word-spacing: normal"><em>填写图片摘要（选填）</em></span></p>
<div style="line-height: 28px; padding-top: 5px">
<div style="overflow: hidden; text-align: center; padding: 0px 0px 34px; position: relative">
<span style="color: #999999"><span style="vertical-align: middle; max-width: 100%"><img src="./LuaFramework 实战 - 田树东 - 博客园_files/001TylVCzy72QaTnIee9a" alt="" title="" style="border: 0px; vertical-align: middle; max-width: 100%"></span></span><span style="color: rgb(153,153,153); display: block; padding: 5px 7px 0px; font-size: 14px; line-height: 20px; outline: none"><em>&#65533;1&#65533;3LoadAssetRequest</em></span><span style="color: #999999"><span>&nbsp;</span></span></div>
</div>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
由于采用异步加载，加载资源的过程中，程序有可能发起同一个请求，多次加载似乎有些浪费，如下图所示。</p>
<div style="line-height: 28px; padding-top: 5px">
<div style="overflow: hidden; text-align: center; padding: 0px 0px 34px; position: relative">
<span style="color: #999999"><span style="vertical-align: middle; max-width: 100%"><img src="./LuaFramework 实战 - 田树东 - 博客园_files/001TylVCzy72QaUemtI5a" alt="" title="" style="border: 0px; vertical-align: middle; max-width: 100%"></span></span><span style="color: rgb(153,153,153); display: block; padding: 5px 7px 0px; font-size: 14px; line-height: 20px; outline: none"><em>&#65533;1&#65533;3两次加载同一资源</em></span></div>
</div>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
更好的办法是，在收到第2次请求时先做判断，如果该资源正在加载，那先记录请求2的回调函数，待资源加载完成，调用所有请求该资源的回调函数，如下图所示。m_LoadRequests便记录每种资源的请求，使程序可以判断该资源是否正在加载，并从m_LoadRequests获取各个资源请求的回调函数。</p>
<div style="line-height: 28px; padding-top: 5px">
<div style="overflow: hidden; text-align: center; padding: 0px 0px 34px; position: relative">
<span style="color: #999999"><span style="vertical-align: middle; max-width: 100%"><img src="./LuaFramework 实战 - 田树东 - 博客园_files/001TylVCzy72QaWMcGR71" alt="" title="" style="border: 0px; vertical-align: middle; max-width: 100%"></span><span>&nbsp;</span></span><span style="color: rgb(153,153,153); display: block; padding: 5px 7px 0px; font-size: 14px; line-height: 20px; outline: none"><em>&#65533;1&#65533;3记录请求2的回调函数</em></span></div>
</div>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
简化后的代码如下：</p>
<pre style="margin-top: 0px; margin-bottom: 0px; padding: 0px"><code>void LoadAsset(包名)
{
       If(m_LoadRequests[abName] == null)
       {
              m_LoadRequests[包名].Add(回调函数等);
              OnLoadAsset();
       }
       else
       {
              m_LoadRequests[包名].Add(回调函数等);
       }
}

IEnumerator OnLoadAsset(XXX)
{
       加载包
       加载资源
       foreach( request in  m_LoadRequests[包名] )
       {
              Request.回调函数();
       }
</code>

<code>}</code></pre>
</div>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<br>
</p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
</p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="word-spacing: normal">为实现代码热更新，在Unity3D中使用<b style="color:black;background-color:#ffff66">lua</b>，然而为此也需付出不少代价。其一，使代码结构混乱（尽管可以优化），其二降低了运行速度，其三增加学习成本（还要多学一门语言）。为了热更新，所有的逻辑都要用<b style="color:black;background-color:#ffff66">lua</b>编写，那么怎样用<b style="color:black;background-color:#ffff66">lua</b>编写游戏逻辑呢？</span><br>
</p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
By 罗培羽 （知乎 @罗培羽）</p>
<h1 style="margin: 0px 0px 16px; padding: 0px; font-size: 34px; font-weight: 400; line-height: 50px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun">
<strong>1、<b style="color:black;background-color:#ffff66">Lua</b>的Update方法</strong></h1>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
第一篇“代码热更新”演示了用<b style="color:black;background-color:#ffff66">lua</b>打印HelloWorld的方法，第二篇“资源热更新”演示了加载坦克模型的方法。这一篇要把两者结合起来，用<b style="color:black;background-color:#ffff66">lua</b>实现“用键盘控制坦克移动”的功能。用<b style="color:black;background-color:#ffff66">Lua</b>和用c#编写的Unity3D程序大同小异，只需正确使用API即可，<b style="color:black;background-color:#ffff66">Lua</b>语言的知识请参见《programing in <b style="color:black;background-color:#ffff66">lua</b>》这本书。</p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
&#65533;6&#65533;7</p>
<h2 style="margin: 0px 0px 18px; padding: 0px; font-size: 24px; font-weight: 400; line-height: 38px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun">
<strong>1）Update方法</strong></h2>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
出于效率的考虑，tolua提供了名为UpdateBeat的对象，在LuaFramework中，只需给UpdateBeat添加回调函数，该函数便会每帧执行，相当于Monobehaviour的Update方法。<b style="color:black;background-color:#ffff66">Lua</b>代码如下所示：</p>
<pre style="margin-top: 0px; margin-bottom: 0px; padding: 0px; color: rgb(51,51,51); font-size: 17px"><code><span style="color: rgb(204,0,0)">function Main()                                 
    UpdateBeat:Add(Update, self)
end
 
function Update()
        LuaFramework.Util.Log("每帧执行一次");</span></code>
<code><span style="color: rgb(204,0,0)">end</span></code>

<code>
</code>
</pre>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
除了UpdateBeat，tolua还提供了LateUpdateBeat和FixedUpdateBeat，对应于Monobehaviour中的LateUpdate和FixedUpdate。</p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
&#65533;6&#65533;7</p>
<h2 style="margin: 0px 0px 18px; padding: 0px; font-size: 24px; font-weight: 400; line-height: 38px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun">
<strong>2）控制坦克</strong></h2>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
现在编写“用键盘控制坦克移动”的<b style="color:black;background-color:#ffff66">lua</b>代码，加载坦克模型后，使用UpdateBeat注册每帧执行的Update方法，然后在Update方法中调用UnityEngine.Input等API实现功能。代码如下：</p>
<pre style="margin-top: 0px; margin-bottom: 0px; padding: 0px; color: rgb(51,51,51); font-size: 17px"><code><span style="color: rgb(204,0,0)">local go; </span></code><code><span style="color: rgb(85,164,85)">--加载的坦克模型</span></code>

<code><span style="color: rgb(85,164,85)">--主入口函数。从这里开始<b style="color:black;background-color:#ffff66">lua</b>逻辑</span></code><code><span style="color: rgb(204,0,0)">function Main()
                                        
        LuaHelper = LuaFramework.LuaHelper;
        resMgr = LuaHelper.GetResManager();
        resMgr:LoadPrefab('tank', { 'TankPrefab' }, OnLoadFinish);
end
 
</span></code><code><span style="color: rgb(85,164,85)">--加载完成后的回调--</span></code><code><span style="color: rgb(204,0,0)">
function OnLoadFinish(objs)
        go = UnityEngine.GameObject.Instantiate(objs[0]);
        LuaFramework.Util.Log("LoadFinish");
        
        UpdateBeat:Add(Update, self)
end
 
</span></code><code><span style="color: rgb(85,164,85)">--每帧执行</span></code><code><span style="color: rgb(204,0,0)">
function Update()
        LuaFramework.Util.Log("每帧执行");
        
        local Input = UnityEngine.Input;
        local horizontal = Input.GetAxis("Horizontal");
        local verticla = Input.GetAxis("Vertical");
        
        local x = go.transform.position.x + horizontal
        local z = go.transform.position.z + verticla
        go.transform.position = Vector3.New(x,0,z)</span></code>
<code><span style="color: rgb(204,0,0)">end</span></code>

<code><span style="color: rgb(204,0,0)">
</span></code>
</pre>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
运行游戏，即可用键盘的控制坦克移动。</p>
<div style="color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px; line-height: 28px; padding-top: 5px">
<div style="overflow: hidden; text-align: center; padding: 0px 0px 34px; position: relative">
<span style="color: #999999"><span style="vertical-align: middle; max-width: 100%"><img src="./LuaFramework 实战 - 田树东 - 博客园_files/001TylVCzy737HibabPad" alt="" title="" style="border: 0px; vertical-align: middle; max-width: 100%"></span></span><span style="color: rgb(153,153,153); display: block; padding: 5px 7px 0px; font-size: 14px; line-height: 20px; outline: none"><em>&#65533;1&#65533;3用键盘的控制坦克移动</em></span><span style="color: #999999"><span>&nbsp;</span></span></div>
</div>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<br>
</p>
<h1 style="margin: 0px 0px 16px; padding: 0px; font-size: 34px; font-weight: 400; line-height: 50px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun">
2、<strong>自定义API</strong></h1>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
框架中提供了数十个可供<b style="color:black;background-color:#ffff66">lua</b>调用的c#类，但这些往往不够用，需要自己添加，本节将介绍添加自定义API的方法。</p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
&#65533;6&#65533;7</p>
<h2 style="margin: 0px 0px 18px; padding: 0px; font-size: 24px; font-weight: 400; line-height: 38px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun">
<strong>1）编写c#类</strong></h2>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
例如，编写TestLuaFun.类，它包含一个静态方法Log，会打印出“《Unity3D网络游戏<b style="color:black;background-color:#99ff99">实战</b>》是一本好书！”和“《手把手教你用c#制作rpg游戏》也是一本好书！”两行文本。</p>
<pre style="margin-top: 0px; margin-bottom: 0px; padding: 0px; color: rgb(51,51,51); font-size: 17px"><code><span style="color: rgb(204,0,0)">using UnityEngine;
using System.Collections;
 
public class TestLuaFun 
{
        public static void Log() 
        {
                Debug.Log("《Unity3D网络游戏<b style="color:black;background-color:#99ff99">实战</b>》是一本好书！");
                Debug.Log("《手把手教你用c#制作rpg游戏》也是一本好书！");
        }</span></code>
<code><span style="color: rgb(204,0,0)">}</span></code>

<code><span style="color: rgb(204,0,0)">
</span></code>
</pre>
<h2 style="margin: 0px 0px 18px; padding: 0px; font-size: 24px; font-weight: 400; line-height: 38px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun">
<strong>2）修改CustomSetting</strong></h2>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
打开CustomSetting.cs，在customTypeList中添加一句“_GT(typeof(TestLuaFun))”。</p>
<div style="color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px; line-height: 28px; padding-top: 5px">
<div style="overflow: hidden; text-align: center; padding: 0px 0px 34px; position: relative">
<span style="color: #999999"><span style="vertical-align: middle; max-width: 100%"><img src="./LuaFramework 实战 - 田树东 - 博客园_files/001TylVCzy737HkLZoO9e" alt="" title="" style="border: 0px; vertical-align: middle; max-width: 100%"></span></span><span style="color: rgb(153,153,153); display: block; padding: 5px 7px 0px; font-size: 14px; line-height: 20px; outline: none"><em>&#65533;1&#65533;3修改CustomSetting</em></span></div>
</div>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<br>
</p>
<h2 style="margin: 0px 0px 18px; padding: 0px; font-size: 24px; font-weight: 400; line-height: 38px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun">
3）<strong>生成wrap文</strong></h2>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
点击菜单栏的<b style="color:black;background-color:#ffff66">Lua</b>→Clear wrap files和<b style="color:black;background-color:#ffff66">Lua</b>→Generate All，重新生成wrap文件。由于刚刚在customTypeList添加了类，所以会生成TestLuaFun类的wrap文件TestLuaFunWrap.cs。</p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
&#65533;6&#65533;7</p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
打开TestLuaFunWrap.cs，可以看到TestLuaFun注册了Log方法。关于static int Log(IntPtr L)的具体含义，请参见《programing in <b style="color:black;background-color:#ffff66">lua</b>》中<b style="color:black;background-color:#ffff66">lua</b>与c++交互的章节。</p>
<div style="color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px; line-height: 28px; padding-top: 5px">
<div style="overflow: hidden; text-align: center; padding: 0px 0px 34px; position: relative">
<span style="color: #999999"><span style="vertical-align: middle; max-width: 100%"><img src="./LuaFramework 实战 - 田树东 - 博客园_files/001TylVCzy737Ho8oAp51" alt="" title="" style="border: 0px; vertical-align: middle; max-width: 100%"></span></span><span style="color: rgb(153,153,153); display: block; padding: 5px 7px 0px; font-size: 14px; line-height: 20px; outline: none"><em>&#65533;1&#65533;3TestLuaFunWrap</em></span></div>
</div>
<h2 style="margin: 0px 0px 18px; padding: 0px; font-size: 24px; font-weight: 400; line-height: 38px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun">
<strong>4）测试API</strong></h2>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
修改main.<b style="color:black;background-color:#ffff66">lua</b>，调用TestLuaFun.Log() ，即可看到效果。</p>
<pre style="margin-top: 0px; margin-bottom: 0px; padding: 0px; color: rgb(51,51,51); font-size: 17px"><code><span style="color: rgb(85,164,85)">--主入口函数。从这里开始<b style="color:black;background-color:#ffff66">lua</b>逻辑</span></code><code><span style="color: rgb(204,0,0)">
function Main()                                 
        TestLuaFun.Log()  </span></code>
<code><span style="color: rgb(204,0,0)">end</span></code>
</pre>
<div style="color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px; line-height: 28px; padding-top: 5px">
<div style="overflow: hidden; text-align: center; padding: 0px 0px 34px; position: relative">
<span style="color: #999999"><span style="vertical-align: middle; max-width: 100%"><img src="./LuaFramework 实战 - 田树东 - 博客园_files/001TylVCzy737Hy1Z5H4d" alt="" title="" style="border: 0px; vertical-align: middle; max-width: 100%"></span></span><span style="color: rgb(153,153,153); display: block; padding: 5px 7px 0px; font-size: 14px; line-height: 20px; outline: none"><em>&#65533;1&#65533;3调用自定义API</em></span></div>
</div>
<h1 style="margin: 0px 0px 16px; padding: 0px; font-size: 34px; font-weight: 400; line-height: 50px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun">
<strong>3、原理</strong></h1>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
tolua实现了LuaInterface，抛开luaFramework，只需创建<b style="color:black;background-color:#ffff66">lua</b>虚拟机，便能在c#中调用<b style="color:black;background-color:#ffff66">lua</b>代码，如下所示。</p>
<pre style="margin-top: 0px; margin-bottom: 0px; padding: 0px; color: rgb(51,51,51); font-size: 17px"><code><span style="color: rgb(204,0,0)">using UnityEngine;
using System.Collections;
using LuaInterface;
 
public class test : MonoBehaviour
{
        void Start () 
        {
                </span></code><code><span style="color: rgb(85,164,85)">//初始化</span></code><code><span style="color: rgb(204,0,0)">
                LuaState <b style="color:black;background-color:#ffff66">lua</b> = new LuaState();
                LuaBinder.Bind(<b style="color:black;background-color:#ffff66">lua</b>);
                </span></code><code><span style="color: rgb(85,164,85)">//<b style="color:black;background-color:#ffff66">lua</b>代码</span></code><code><span style="color: rgb(204,0,0)">
                string luaStr =
                        @"                
                        print('hello tolua#, 广告招租')
                        LuaFramework.Util.Log('HelloWorld');
                        TestLuaFun.Log()                
                ";
                </span></code><code><span style="color: rgb(85,164,85)">//执行<b style="color:black;background-color:#ffff66">lua</b>脚本</span></code><code><span style="color: rgb(204,0,0)">
                <b style="color:black;background-color:#ffff66">lua</b>.DoString(luaStr);
        }</span></code>
<code><span style="color: rgb(204,0,0)">}&nbsp;</span></code>

<code><span style="color: rgb(204,0,0)">&#65533;6&#65533;7</span></code>
</pre>
<div style="color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px; line-height: 28px; padding-top: 5px">
<div style="overflow: hidden; text-align: center; padding: 0px 0px 34px; position: relative">
<span style="color: #999999"><span style="vertical-align: middle; max-width: 100%"><img src="./LuaFramework 实战 - 田树东 - 博客园_files/001TylVCzy737HzMixtf3" alt="" title="" style="border: 0px; vertical-align: middle; max-width: 100%"></span></span><span style="color: rgb(153,153,153); display: block; padding: 5px 7px 0px; font-size: 14px; line-height: 20px; outline: none"><em>&#65533;1&#65533;3创建<b style="color:black;background-color:#ffff66">lua</b>虚拟机，执行<b style="color:black;background-color:#ffff66">lua</b>代码</em></span></div>
</div>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
实际上LuaFramework也是用了相似的方法，框架启动后，会创建LuaManager、LuaLooper的实例。LuaManager创建<b style="color:black;background-color:#ffff66">lua</b>虚拟机并调用Main.<b style="color:black;background-color:#ffff66">lua</b>的Main方法，LuaLooper处理了UpdateBeat相关的事情。如下所示：</p>
<div style="color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px; line-height: 28px; padding-top: 5px">
<div style="overflow: hidden; text-align: center; padding: 0px 0px 34px; position: relative">
<span style="color: #999999"><span style="vertical-align: middle; max-width: 100%"><img src="./LuaFramework 实战 - 田树东 - 博客园_files/001TylVCzy737HBziPFe3" alt="" title="" style="border: 0px; vertical-align: middle; max-width: 100%"></span></span><span style="color: rgb(153,153,153); display: block; padding: 5px 7px 0px; font-size: 14px; line-height: 20px; outline: none"><em>&#65533;1&#65533;3LuaManager的启动过程<span style="white-space: pre"></span></em></span>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<br>
</p>
<span style="text-align: left; color: rgb(153,153,153); display: block; padding: 5px 7px 0px; font-size: 14px; line-height: 20px; outline: none"><em></em></span></div>
</div>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<br>
</p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
基于组件的编程模式是Unity3D的核心思想之一，然而使用纯<b style="color:black;background-color:#ffff66">lua</b>编程，基本就破坏了这一模式。那么有没有办法做一些封装，让<b style="color:black;background-color:#ffff66">Lua</b>脚本也能挂载到游戏物体上，作为组件呢？</p>
<h1 style="margin: 0px 0px 16px; padding: 0px; font-size: 34px; font-weight: 400; line-height: 50px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun">
1、设计思想</h1>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
在需要添加<b style="color:black;background-color:#ffff66">Lua</b>组件的游戏物体上添加一个LuaComponent组件，LuaComponent引用一个<b style="color:black;background-color:#ffff66">lua</b>表，这个<b style="color:black;background-color:#ffff66">lua</b>表包含<b style="color:black;background-color:#ffff66">lua</b>组件的各种属性以及Awake、Start等函数，由LuaComponent适时调用<b style="color:black;background-color:#ffff66">Lua</b>表所包含的函数。</p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
下面列举<b style="color:black;background-color:#ffff66">lua</b>组件的文件格式，它包含一个表（如Component），这个表包含property1 、property2 等属性，包含Awake、Start等方法。表中必须包含用于派生对象的New方法，它会创建一个继承自Component的表o，供LuaComponent调用。</p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">Component= &nbsp;&nbsp;&nbsp;--</span><span style="color: rgb(213,106,0)">组件表</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&#65533;6&#65533;7</span><span style="color: rgb(213,106,0); word-spacing: normal">{</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; property1 = 100,</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;property2 =&nbsp;“helloWorld”</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">}</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&#65533;6&#65533;7</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp;</span><span style="color: rgb(213,106,0); word-spacing: normal">function Component:Awake()&nbsp;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; print("TankCmp Awake name = "..self.name );</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">end</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">function Component:Start()&nbsp;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; print("TankCmp Start name = "..self.name );</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">End</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">--</span><span style="color: rgb(213,106,0)">更多方法略</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">function Component:New(obj)&nbsp;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; local o = {}&nbsp;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; setmetatable(o, self) &nbsp;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; self.__index = self &nbsp;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; return o</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">end &nbsp;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
&nbsp;</p>
<h1 style="margin: 0px 0px 16px; padding: 0px; font-size: 34px; font-weight: 400; line-height: 50px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun">
2、LuaComponent组件</h1>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
LuaComponent主要有Get和Add两个静态方法，其中Get相当于UnityEngine中的GetComponent方法，Add相当于AddComponent方法，只不过这里添加的是<b style="color:black;background-color:#ffff66">lua</b>组件不是c#组件。每个LuaComponent拥有一个LuaTable（<b style="color:black;background-color:#ffff66">lua</b>表）类型的变量table，它既引用上述的Component表。</p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
Add方法使用AddComponent添加LuaComponent，调用参数中<b style="color:black;background-color:#ffff66">lua</b>表的New方法，将其返回的表赋予table。</p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
Get方法使用GetComponents获取游戏对象上的所有LuaComponent（一个游戏对象可能包含多个<b style="color:black;background-color:#ffff66">lua</b>组件，由参数table决定需要获取哪一个），通过元表地址找到对应的LuaComponent，返回<b style="color:black;background-color:#ffff66">lua</b>表。代码如下：</p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">using UnityEngine;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">using System.Collections;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">using LuaInterface;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">using LuaFramework;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">public class LuaComponent : MonoBehaviour</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">{</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; //<b style="color:black;background-color:#ffff66">Lua</b>表</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; public LuaTable table;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; //添加<b style="color:black;background-color:#ffff66">LUA</b>组件 &nbsp;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; public static LuaTable Add(GameObject go, LuaTable tableClass) &nbsp;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; { &nbsp;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LuaFunction fun = tableClass.GetLuaFunction("New");</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (fun == null)</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return null;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; object[] rets = fun.Call (tableClass);</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (rets.Length != 1)</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return null;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LuaComponent cmp = go.AddComponent(); &nbsp;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cmp.table = (LuaTable)rets[0];</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cmp.CallAwake ();</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return cmp.table;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; } &nbsp;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; //获取<b style="color:black;background-color:#ffff66">lua</b>组件</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; public static LuaTable Get(GameObject go,LuaTable table) &nbsp;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; { &nbsp;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LuaComponent[] cmps = go.GetComponents(); &nbsp;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; foreach (LuaComponent cmp in cmps)</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; string mat1 = table.ToString();</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; string mat2 = cmp.table.GetMetaTable().ToString();</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if(mat1 == mat2)</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return cmp.table;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return null; &nbsp;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; } &nbsp;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; //删除<b style="color:black;background-color:#ffff66">LUA</b>组件的方法略，调用Destory()即可 &nbsp;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; void CallAwake ()</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; {</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LuaFunction fun = table.GetLuaFunction("Awake");</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (fun != null)</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fun.Call (table, gameObject);</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; }</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; void Start ()</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; {</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LuaFunction fun = table.GetLuaFunction("Start");</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (fun != null)</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fun.Call (table, gameObject);</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; }</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; void Update ()</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; {</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //效率问题有待测试和优化</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //可在<b style="color:black;background-color:#ffff66">lua</b>中调用UpdateBeat替代</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LuaFunction fun = table.GetLuaFunction("Update");</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (fun != null)</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fun.Call (table, gameObject);</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; }</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; void OnCollisionEnter(Collision collisionInfo)</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; {</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //略</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; }</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; //更多函数略</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">}</span></p>
<h1 style="margin: 0px 0px 16px; padding: 0px; font-size: 34px; font-weight: 400; line-height: 50px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun">
3、调试LuaCompomemt</h1>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
现在编写名为TankCmp的<b style="color:black;background-color:#ffff66">lua</b>组件，测试LuaCompomemt的功能，TankCmp会在Awake、Start和Update打印出属性name。TankCmp.<b style="color:black;background-color:#ffff66">lua</b>的代码如下：</p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">TankCmp =</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">{</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; --里面可以放一些属性</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; Hp = 100,</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; att = 50,</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; name = "good tank",</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">}</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">function TankCmp:Awake()</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; print("TankCmp Awake name = "..self.name );</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">end</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">function TankCmp:Start()</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; print("TankCmp Start name = "..self.name );</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">end</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">function TankCmp:Update()</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; print("TankCmp Update name = "..self.name );</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">end</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">--创建对象</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">function TankCmp:New(obj)</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; local o = {}</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp;setmetatable(o, self) &nbsp;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp;self.__index = self &nbsp;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; return o</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">end &nbsp;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
&nbsp;</p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
编写Main.<b style="color:black;background-color:#ffff66">lua</b>，给游戏对象添加<b style="color:black;background-color:#ffff66">lua</b>组件。</p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">require "TankCmp"</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">--主入口函数。从这里开始<b style="color:black;background-color:#ffff66">lua</b>逻辑</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">function Main()</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; --组件1</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; local go = UnityEngine.GameObject ('go')</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; local tankCmp1 = LuaComponent.Add(go,TankCmp)</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; tankCmp1.name = "Tank1"</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; --组件2</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; local go2 = UnityEngine.GameObject ('go2')</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; LuaComponent.Add(go2,TankCmp)</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; local tankCmp2 = LuaComponent.Get(go2,TankCmp)</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; tankCmp2.name = "Tank2"</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">end</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
运行游戏，即可看到<b style="color:black;background-color:#ffff66">lua</b>组件的运行结果：</p>
<div style="color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px; line-height: 28px; padding-top: 5px">
<div style="overflow: hidden; text-align: center; padding: 0px 0px 34px; position: relative">
<span style="color: #999999"><span style="vertical-align: middle; max-width: 100%"><img src="./LuaFramework 实战 - 田树东 - 博客园_files/001TylVCzy73pq8y9pf31" alt="" title="" style="border: 0px; vertical-align: middle; max-width: 100%"></span></span><span style="color: rgb(153,153,153); display: block; padding: 5px 7px 0px; font-size: 14px; line-height: 20px; outline: none"><em>&#65533;1&#65533;3程序运行结果</em></span><span style="color: #999999"><span>&nbsp;</span></span></div>
</div>
<div style="color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px; line-height: 28px; padding-top: 5px">
<div style="overflow: hidden; text-align: center; padding: 0px 0px 34px; position: relative">
<span style="color: #999999"><span style="vertical-align: middle; max-width: 100%"><img src="./LuaFramework 实战 - 田树东 - 博客园_files/001TylVCzy73pq9fF6Ve9" alt="" title="" style="border: 0px; vertical-align: middle; max-width: 100%"></span></span><span style="color: rgb(153,153,153); display: block; padding: 5px 7px 0px; font-size: 14px; line-height: 20px; outline: none"><em>&#65533;1&#65533;3程序运行结果</em></span></div>
</div>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<br>
</p>
<h1 style="margin: 0px 0px 16px; padding: 0px; font-size: 34px; font-weight: 400; line-height: 50px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun">
4、坦克组件</h1>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
下面代码演示用<b style="color:black;background-color:#ffff66">lua</b>组件实现“用键盘控制坦克移动”的功能，TankCmp.<b style="color:black;background-color:#ffff66">lua</b>的代码如下：</p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">TankCmp =</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">{</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<span style="color: rgb(213,106,0)">name = "good tank",</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">}</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">function TankCmp:Update(gameObject)</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<span style="color: rgb(213,106,0)">print("TankCmp Update name = "..self.name );</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<span style="color: rgb(213,106,0)">local Input = UnityEngine.Input;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<span style="color: rgb(213,106,0)">local horizontal = Input.GetAxis("Horizontal");</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<span style="color: rgb(213,106,0)">local verticla = Input.GetAxis("Vertical");</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<span style="color: rgb(213,106,0)">local x = gameObject.transform.position.x + horizontal</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<span style="color: rgb(213,106,0)">local z = gameObject.transform.position.z + verticla</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<span style="color: rgb(213,106,0)">gameObject.transform.position = Vector3.New(x,0,z)</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">end</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">--创建对象</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">function TankCmp:New(obj)</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">local o = {}</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<span style="color: rgb(213,106,0)">setmetatable(o, self) &nbsp;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<span style="color: rgb(213,106,0)">self.__index = self &nbsp;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<span style="color: rgb(213,106,0)">return o</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">end &nbsp;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
Main.<b style="color:black;background-color:#ffff66">lua</b>先加载坦克模型，然后给他添加<b style="color:black;background-color:#ffff66">lua</b>组件，代码如下：</p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
require "TankCmp"</p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
&nbsp;</p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
--主入口函数。从这里开始<b style="color:black;background-color:#ffff66">lua</b>逻辑</p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">function Main()</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; LuaHelper = LuaFramework.LuaHelper;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; resMgr = LuaHelper.GetResManager();</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; resMgr:LoadPrefab('tank', { 'TankPrefab' }, OnLoadFinish);</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">end</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">--加载完成后的回调--</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">function OnLoadFinish(objs)</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; go = UnityEngine.GameObject.Instantiate(objs[0]);</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; LuaComponent.Add(go,TankCmp)</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<span style="color: rgb(213,106,0)">end</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
&nbsp;</p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
运行游戏，即可用键盘的控制坦克移动。</p>
<div style="color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px; line-height: 28px; padding-top: 5px">
<div style="overflow: hidden; text-align: center; padding: 0px 0px 34px; position: relative">
<span style="color: #999999"><span style="vertical-align: middle; max-width: 100%"><img src="./LuaFramework 实战 - 田树东 - 博客园_files/001TylVCzy73pqhwQiZf9" alt="" title="" style="border: 0px; vertical-align: middle; max-width: 100%"></span></span><span style="color: rgb(153,153,153); display: block; padding: 5px 7px 0px; font-size: 14px; line-height: 20px; outline: none"><em>&#65533;1&#65533;3坦克组件运行结果</em></span></div>
</div>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
<br>
</p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun; font-size: 17px">
</p>
<div class="BNE_title" style="border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: rgb(238,238,238); color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun">
<h1 class="h1_tit" id="t_6788cd880102wc4j" style="margin: 0px; padding: 0px; font-size: 34px; font-weight: 400; line-height: 50px; word-spacing: normal">
<br>
</h1>
</div>
<div class="BNE_cont" id="sina_keyword_ad_area2" style="width: 670px; min-height: 230px; font-size: 17px; line-height: 28px; margin-top: 20px; overflow: hidden; color: rgb(51,51,51); font-family: &quot;Microsoft Yahei&quot;, Simsun">
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="word-spacing: normal">界面系统在游戏中占据重要地位。游戏界面是否友好，很大程度上决定了玩家的体验；界面开发是否便利，也影响着游戏的开发进度。</span><span style="word-spacing: normal">Unity3D</span>&nbsp;<span style="word-spacing: normal">的</span><span style="word-spacing: normal">UGUI</span><span style="word-spacing: normal">系统，使用户可以“可视化地”开发界面，那么怎样用</span><span style="word-spacing: normal"><b style="color:black;background-color:#ffff66">Lua</b></span><span style="word-spacing: normal">去调用</span><span style="word-spacing: normal">UGUI</span><span style="word-spacing: normal">呢？</span><br>
</p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="font-size: 24px"><strong>1、显示UI界面</strong></span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
下面演示如何显示一个UI界面。由于UI界面也是一种资源，使用第二篇“资源热更新”的方法即可。这个例子中，制作一个含有按钮的界面，然后组成名为Panel1的UI预设，存放到Tank目录下。</p>
<div style="line-height: 28px; padding-top: 5px">
<div style="overflow: hidden; text-align: center; padding: 0px 0px 34px; position: relative">
<span style="color: #999999"><span style="vertical-align: middle; max-width: 100%"><img src="./LuaFramework 实战 - 田树东 - 博客园_files/001TylVCzy73AA1962662" alt="" title="" style="border: 0px; vertical-align: middle; max-width: 100%"></span></span><span style="color: rgb(153,153,153); display: block; padding: 5px 7px 0px; font-size: 14px; line-height: 20px; outline: none"><em>&#65533;1&#65533;3图：Panel1</em></span></div>
</div>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
前面（第二篇）已在Packager类HandleExampleBundle方法中添加了一句“AddBuildMap("tank" + AppConst.ExtName, "*.prefab", "Assets/Tank");”（当然也可以添加到其他地方），它会把Tank目录下的所有预设打包成名为tank的资源包。故而点击“Build xxx Resource”后，Panel1也会被打包到tank资源包中。</p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
修改<b style="color:black;background-color:#ffff66">Lua</b>入口函数Main.<b style="color:black;background-color:#ffff66">lua</b>中的Main方法，在加载资源后把panel1放到<span style="word-spacing: normal">Canvas</span><span style="word-spacing: normal">下（需要在场景中添加画布），然后调整它的位置和大小。</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<br>
</p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">--主入口函数。从这里开始<b style="color:black;background-color:#ffff66">lua</b>逻辑</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">function Main()</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; LuaHelper = LuaFramework.LuaHelper;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; resMgr = LuaHelper.GetResManager();</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; resMgr:LoadPrefab('tank', { 'Panel1' }, OnLoadFinish);</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">end</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">--加载完成后的回调--</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">function OnLoadFinish(objs)</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; --显示面板</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; go = UnityEngine.GameObject.Instantiate(objs[0]);</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; local parent = UnityEngine.GameObject.Find("Canvas")</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; go.transform:SetParent(parent.transform);</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; go.transform.localScale = Vector3.one;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; go.transform.localPosition = Vector3.zero;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">end</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<br>
</p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
运行游戏，即可看到加载出来的界面。</p>
<div style="line-height: 28px; padding-top: 5px">
<div style="overflow: hidden; text-align: center; padding: 0px 0px 34px; position: relative">
<span style="color: #999999"><span style="vertical-align: middle; max-width: 100%"><img src="./LuaFramework 实战 - 田树东 - 博客园_files/001TylVCzy73AA2MitF17" alt="" title="" style="border: 0px; vertical-align: middle; max-width: 100%"></span></span><span style="color: rgb(153,153,153); display: block; padding: 5px 7px 0px; font-size: 14px; line-height: 20px; outline: none"><em>&#65533;1&#65533;3图：加载出来的界面</em></span></div>
</div>
<h2 style="margin: 0px 0px 18px; padding: 0px; font-size: 24px; font-weight: 400; line-height: 38px">
<strong>2、事件响应</strong></h2>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
c#中可以使用事件监听的方法给UI组件添加事件。例如，添加按钮点击事件的方法如下：</p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Button btn = go.GetComponent&nbsp;</span>
<button style="font-size: 12px; line-height: 1.125; font-family: &quot;Microsoft Yahei&quot;, Simsun; margin: 0px; padding: 0px">
();</button></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; btn.onClick.AddListener</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; delegate()&nbsp;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; this.OnClick(go)</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; );</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
&nbsp;</p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
然而在LuaFramework的API中，没能找到合适的方法，只能根据第三篇中“自定义API”的方法，自己编写一套了。编写<span style="word-spacing: normal">UIEvent</span><span style="word-spacing: normal">类，它包含用于添加监听事件的</span><span style="word-spacing: normal">AdonClick</span><span style="word-spacing: normal">和清除监听事件的</span><span style="word-spacing: normal">ClearButtonClick</span><span style="word-spacing: normal">方法，代码如下所示（完成后记得要</span><span style="word-spacing: normal">“修改</span><span style="word-spacing: normal">CustomSetting</span><span style="word-spacing: normal">”和“生成</span><span style="word-spacing: normal">wrap</span><span style="word-spacing: normal">文件”</span><span style="word-spacing: normal">）。</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">using UnityEngine;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">using System.Collections;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">using LuaInterface;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">using UnityEngine.UI;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">public class UIEvent&nbsp;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">{</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; //添加监听</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; public static void AdonClick(GameObject go, LuaFunction luafunc)&nbsp;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; {</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (go == null || luafunc == null)&nbsp;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Button btn = go.GetComponent&nbsp;</span>
<button style="font-size: 12px; line-height: 1.125; font-family: &quot;Microsoft Yahei&quot;, Simsun; margin: 0px; padding: 0px">
();</button></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (btn == null)</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; btn.onClick.AddListener</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; delegate()&nbsp;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; luafunc.Call(go);</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; );</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; }</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; //清除监听</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; public static void ClearButtonClick(GameObject go)&nbsp;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; {</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (go == null)&nbsp;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Button btn = go.GetComponent&nbsp;</span>
<button style="font-size: 12px; line-height: 1.125; font-family: &quot;Microsoft Yahei&quot;, Simsun; margin: 0px; padding: 0px">
();</button></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (btn == null)</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; btn.onClick.RemoveAllListeners();</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; }</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">}</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
接下来测试下这套API，修改Main.<b style="color:black;background-color:#ffff66">lua</b>，代码如下：</p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">--主入口函数。从这里开始<b style="color:black;background-color:#ffff66">lua</b>逻辑</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">function Main() &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; 略</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">end</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">--加载完成后的回调--</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">function OnLoadFinish(objs)</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; --显示面板</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; 略</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; --事件处理</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; local btn = go.transform:FindChild("Button").gameObject</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; UIEvent.AdonClick(btn, OnClick)</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">end</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">function OnClick()</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">&nbsp; &nbsp; &nbsp; &nbsp; print("触发按钮事件")</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="color: rgb(213,106,0)">end</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
运行游戏，点击按钮，OnClick方法即被调用。</p>
<div style="line-height: 28px; padding-top: 5px">
<div style="overflow: hidden; text-align: center; padding: 0px 0px 34px; position: relative">
<span style="color: #999999"><span style="vertical-align: middle; max-width: 100%"><img src="./LuaFramework 实战 - 田树东 - 博客园_files/001TylVCzy73AA4nCg707" alt="" title="" style="border: 0px; vertical-align: middle; max-width: 100%"></span></span><span style="color: rgb(153,153,153); display: block; padding: 5px 7px 0px; font-size: 14px; line-height: 20px; outline: none"><em>&#65533;1&#65533;3图：按钮的事件响应</em></span></div>
</div>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
读者可以使用相似的方法监听其他UI组件，这里就只演示按钮事件了。</p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
&#65533;6&#65533;7</p>
<h2 style="margin: 0px 0px 18px; padding: 0px; font-size: 24px; font-weight: 400; line-height: 38px">
3、<strong>界面管理器</strong></h2>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
LuaFramework提供了一套简单的（不完善的）界面管理器，具体代码请参见PanelManager类。PanelManager类的CreatePanel方法完成异步加载资源，在加载完成后，会设置面板的大小和位置，然后调用回调函数。与上面用<b style="color:black;background-color:#ffff66">lua</b>加载界面的方法完全一样。</p>
<div style="line-height: 28px; padding-top: 5px">
<div style="overflow: hidden; text-align: center; padding: 0px 0px 34px; position: relative">
<span style="color: #999999"><span style="vertical-align: middle; max-width: 100%"><img src="./LuaFramework 实战 - 田树东 - 博客园_files/001TylVCzy73AA5Aohdbb" alt="" title="" style="border: 0px; vertical-align: middle; max-width: 100%"></span></span><span style="color: rgb(153,153,153); display: block; padding: 5px 7px 0px; font-size: 14px; line-height: 20px; outline: none"><em>&#65533;1&#65533;3图：PanelManager的CreatePanel方法</em></span></div>
</div>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<br>
</p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
LuaFramework会给每个界面添加名为<b style="color:black;background-color:#ffff66">Lua</b><span style="word-spacing: normal">Behaviour</span><span style="word-spacing: normal">的组件，它拥有用于添加按钮监听的</span><span style="word-spacing: normal">AddClick</span><span style="word-spacing: normal">方法，</span><span style="word-spacing: normal">相关代码如下，与</span><span style="word-spacing: normal">UIEvent</span><span style="word-spacing: normal">的</span><span style="word-spacing: normal">AdonClick</span><span style="word-spacing: normal">方法相似。</span></p>
<div style="line-height: 28px; padding-top: 5px">
<div style="overflow: hidden; text-align: center; padding: 0px 0px 34px; position: relative">
<span style="color: #999999"><span style="vertical-align: middle; max-width: 100%"><img src="./LuaFramework 实战 - 田树东 - 博客园_files/001TylVCzy73AA6cDWEd0" alt="" title="" style="border: 0px; vertical-align: middle; max-width: 100%"></span></span><span style="color: rgb(153,153,153); display: block; padding: 5px 7px 0px; font-size: 14px; line-height: 20px; outline: none"><em>&#65533;1&#65533;3图：LuaBehaviour的AddClick方法</em></span></div>
</div>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<br>
</p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
在LuaFramework的PureMVC架构中，如果要<span style="word-spacing: normal">添加一个</span><span style="word-spacing: normal">界面</span><span style="word-spacing: normal">，</span><span style="word-spacing: normal">需要</span><span style="word-spacing: normal">编写对应的</span><span style="word-spacing: normal">Controller</span><span style="word-spacing: normal">、</span><span style="word-spacing: normal">View</span><span style="word-spacing: normal">，以及修改</span><span style="word-spacing: normal">3</span><span style="word-spacing: normal">个框架自带的</span><span style="word-spacing: normal"><b style="color:black;background-color:#ffff66">lua</b></span><span style="word-spacing: normal">文件，比较繁琐</span><span style="word-spacing: normal">。因此在实际项目中有必要重写</span><span style="word-spacing: normal">PanelManager</span><span style="word-spacing: normal">，由它实现界面的加载及事件处理。</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="word-spacing: normal"><br>
</span></p>
<p style="margin-top: 0px; margin-bottom: 22px; padding-top: 0px; padding-bottom: 0px">
<span style="word-spacing: normal"></span></p>
</div>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">LuaFramework内置了网络模块（NetworkManager、SocketClient、ByteBuffer、Converter、Protocal），本篇将会介绍该模块的调用方法以及其原理。</span></p>
<h2 style="margin: 20px 0px; font-weight: 400; line-height: inherit; color: rgb(51,51,51)">
<span style="font-size: 12px">1、<span style="font-weight: 600">发起连接</span></span></h2>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">发起连接是客户端网络通信的第一步，LuaFramewor中，只需通过LuaFramework.AppConst.SocketAddress和LuaFramework.AppConst.SocketPort设置ip和端口，然后调用NetworkManager的SendConnect方法即可发起连接。Main.<b style="color:black;background-color:#ffff66">lua</b>的代码如下：</span></p>
<div class="highlight">
<pre style="margin-top: 1em; margin-bottom: 1em; padding: 10px; overflow: auto; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; background-color: rgb(246,246,246)"><code class="language-text" style="margin: 0px; padding: 0px; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace"><span style="font-size: 12px"><span></span>require "Network"
 
--主入口函数。从这里开始<b style="color:black;background-color:#ffff66">lua</b>逻辑
function Main()		
	local LuaHelper = LuaFramework.LuaHelper
	local networkMgr = LuaHelper.GetNetManager()
	local AppConst = LuaFramework.AppConst
	
    AppConst.SocketPort = 1234;
    AppConst.SocketAddress = "127.0.0.1";
	networkMgr:SendConnect();
end
</span></code></pre>
</div>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">在收到服务端回应后，LuaFramework会调用Network的OnSocket方法（写死）。新建名为Network.<b style="color:black;background-color:#ffff66">lua</b>的文件，处理消息回调。在如下的代码中，Protocal代表协议号，比如“连接服务器”（Protocal.Connect）的协议号是101，在OnSocket的参数中，key便是收到的协议号，data是收到的数据。</span></p>
<div class="highlight">
<pre style="margin-top: 1em; margin-bottom: 1em; padding: 10px; overflow: auto; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; background-color: rgb(246,246,246)"><code class="language-text" style="margin: 0px; padding: 0px; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace"><span style="font-size: 12px"><span></span>Network = {};
 
--协议
Protocal = {
	Connect		= '101';	--连接服务器
	Exception   = '102';	--异常掉线
	Disconnect  = '103';	--正常断线   
	Message		= '104';	--接收消息
}
 
--Socket消息--
function Network.OnSocket(key, data)
	if key == 101 then
		LuaFramework.Util.Log('OnSocket Connect');		
	else
		LuaFramework.Util.Log('OnSocket Other');	
	end
end
</span></code></pre>
</div>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">为了测试网络功能，需要编写服务端，这里使用c#编写一套简单的服务端程序，仅为调试使用，代码如下：</span></p>
<div class="highlight">
<pre style="margin-top: 1em; margin-bottom: 1em; padding: 10px; overflow: auto; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; background-color: rgb(246,246,246)"><code class="language-text" style="margin: 0px; padding: 0px; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace"><span style="font-size: 12px"><span></span>using System;
using System.Net;
using System.Net.Sockets;
using System.Linq;
 
class MainClass
{
	public static void Main(string[] args)
	{
		Console.WriteLine("Hello World!");
		//Socket
		Socket listenfd = new Socket(AddressFamily.InterNetwork,
		                             SocketType.Stream, ProtocolType.Tcp);
		//Bind
		IPAddress ipAdr = IPAddress.Parse("127.0.0.1");
		IPEndPoint ipEp = new IPEndPoint(ipAdr, 1234);
		listenfd.Bind(ipEp);
		//Listen
		listenfd.Listen(0);
		Console.WriteLine("[服务器]启动成功");
		while (true)
		{
			//Accept
			Socket connfd = listenfd.Accept();
			Console.WriteLine("[服务器]Accept");
		}
	}
}
</span></code></pre>
</div>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">运行服务端和客户端，客户端会发起连接，服务端accept该连接后回应，客户端会显示“OnSocket Connect”</span></p>
<img src="./LuaFramework 实战 - 田树东 - 博客园_files/c2b9befe48c2b5860f99b4e109961249_hd.jpg" class="content_image lazy" width="404" alt="" style="overflow: hidden; display: block; max-width: 100%; margin: 0px auto">
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">图：服务端</span></p>
<img src="./LuaFramework 实战 - 田树东 - 博客园_files/735de34c1e0a7baf4bcc0edeec8b9674_hd.jpg" class="origin_image zh-lightbox-thumb lazy" width="692" alt="" style="overflow: hidden; display: block; max-width: 100%; margin: 0px auto">
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">图：客户端</span></p>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">此时把服务端关掉（断开连接），客户端会收到协议号为102的消息，即异常掉线（Exception）。</span></p>
<img src="./LuaFramework 实战 - 田树东 - 博客园_files/9cfb7d5048fd42feb487513b6603a3cb_hd.jpg" class="origin_image zh-lightbox-thumb lazy" width="693" alt="" style="overflow: hidden; display: block; max-width: 100%; margin: 0px auto">
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">图：异常掉线</span></p>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">调用NetworkManager.SendConnect实际是调用BeginConnect发起连接。连接之后，回调OnConnect方法。</span></p>
<img src="./LuaFramework 实战 - 田树东 - 博客园_files/fe86ec36434b2f5d24297333779d06ed_hd.jpg" class="origin_image zh-lightbox-thumb lazy" width="692" alt="" style="overflow: hidden; display: block; max-width: 100%; margin: 0px auto">
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">图：连接过程</span></p>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">OnConnect方法调用NetworkManager.AddEvent，排除设计模式的内容，相当于调用Network.<b style="color:black;background-color:#ffff66">lua</b>的OnSocket方法。传入OnSocket的第1个参数为101（Protocal.Connect），指代协议名，第2个参数是空的字节流。网络模块中定义了101、102、103这3个固定的协议号，分别代表连接服务器、异常断线和正常断线。</span></p>
<img src="./LuaFramework 实战 - 田树东 - 博客园_files/dab7d2b48af2d2c349cf34491de0e56e_hd.jpg" class="origin_image zh-lightbox-thumb lazy" width="692" alt="" style="overflow: hidden; display: block; max-width: 100%; margin: 0px auto"><span style="font-size: 12px"><br style="color: rgb(51,51,51)">
</span>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">图：连接回调</span></p>
<h2 style="margin: 20px 0px; font-weight: 400; line-height: inherit; color: rgb(51,51,51)">
<span style="font-size: 12px">2、<span style="font-weight: 600">发送和接收</span></span></h2>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">接下来尝试发送和接收数据。LuaFramework默认（如果不去改它的代码）使用的协议格式如下图所示，前面的2个字节为消息长度，用于处理沾包分包，随后的2个字节代表协议号（如上面的101、102、103），最后才是消息的内容。</span></p>
<img src="./LuaFramework 实战 - 田树东 - 博客园_files/d80b7b4e22419b25ba1e80113d64f1af_hd.jpg" class="content_image lazy" width="382" alt="" style="overflow: hidden; display: block; max-width: 100%; margin: 0px auto">
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">图：协议</span></p>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">修改Network.<b style="color:black;background-color:#ffff66">lua</b>，在连接成功后（OnSocket方法的101协议），调用send发送一串协议号为104的数据。服务端收到数据后回射给客户端，客户端在收到回应后（OnSocket方法的104协议），读取并显示出来。</span></p>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">send方法中新建了一个buffer，然后往buffer中添加协议号（104）和协议内容（字符串：《Unity3D网络游戏<b style="color:black;background-color:#99ff99">实战</b>》是一本好书！），最后调用networkMgr:SendMessage()发送数据。networkMgr:SendMessage()会自动计算协议长度，并附加到buffer上发送出去。</span></p>
<div class="highlight">
<pre style="margin-top: 1em; margin-bottom: 1em; padding: 10px; overflow: auto; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; background-color: rgb(246,246,246)"><code class="language-text" style="margin: 0px; padding: 0px; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace"><span style="font-size: 12px"><span></span>--Socket消息--
function Network.OnSocket(key, data)
	if key == 101 then
		LuaFramework.Util.Log('OnSocket Connect');	
		Send()
	elseif key == 104 then
		LuaFramework.Util.Log('OnSocket Message ');
		local str = data:ReadString();
		LuaFramework.Util.Log('收到的字符串：'..str);
	else
		LuaFramework.Util.Log('OnSocket Other '..key);	
	end
end
 
function Send()
	--组装数据
    local buffer = LuaFramework.ByteBuffer.New();
    buffer:WriteShort(Protocal.Message);
    buffer:WriteString("《Unity3D网络游戏<b style="color:black;background-color:#99ff99">实战</b>》是一本好书！");
	--发送
	local LuaHelper = LuaFramework.LuaHelper
	local networkMgr = LuaHelper.GetNetManager()
    networkMgr:SendMessage(buffer);
	LuaFramework.Util.Log('数据发送完毕');	
end
</span></code></pre>
</div>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">修改服务端程序，读出接收到的内容，并echo回去。</span></p>
<div class="highlight">
<pre style="margin-top: 1em; margin-bottom: 1em; padding: 10px; overflow: auto; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; background-color: rgb(246,246,246)"><code class="language-text" style="margin: 0px; padding: 0px; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace"><span style="font-size: 12px"><span></span>	public static void Main(string[] args)
	{
		略，没有改动
		while (true)
		{
			//Accept
			Socket connfd = listenfd.Accept();
			Console.WriteLine("[服务器]Accept");
			//Recv 不考虑各种意外，只做测试
			byte[] readBuff = new byte[100];
			int count = connfd.Receive(readBuff);
			//显示字节流
			string showStr = "";
			for (int i = 0; i &lt; count; i++)
			{
				int b = (int)readBuff[i];
				showStr += b.ToString() + " ";
			}
			Console.WriteLine("[服务器接收]字节流："+ showStr);
			//解析协议
			Int16 messageLen = BitConverter.ToInt16(readBuff,0);
			Int16 protocal = BitConverter.ToInt16(readBuff,2);
			Int16 strLen = BitConverter.ToInt16(readBuff,4);
			string str = System.Text.Encoding.UTF8.GetString(readBuff, 6, strLen);
			Console.WriteLine("[服务器接收] 长度：" + messageLen);
			Console.WriteLine("[服务器接收] 协议号：" + protocal);
			Console.WriteLine("[服务器接收] 字符串：" + str);
			//Send（echo）
			byte[] writeBuff = new byte[count];
			Array.Copy(readBuff,writeBuff,count);
			connfd.Send(writeBuff);
		}
	}
</span></code></pre>
</div>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">运行游戏，可以看到服务端收到的如图所示的信息。字节流的前两位“53 0”表示消息长度为53字节，紧跟着的“104 0”代表协议号104。在字符串的封装中（buffer:WriteString），程序会先在buffer中添加字符串的长度，最后才是字符串的内容。“49 0”即表示“《Unity3D网络游戏<b style="color:black;background-color:#99ff99">实战</b>》是一本好书！”占用49个字节（14个中文符号，每个3字节，7个英文符号，每个1字节）。协议长度53字节
 = 协议号2个字节 + 字符串长度2字节 + 字符串内容49字节。</span></p>
<img src="./LuaFramework 实战 - 田树东 - 博客园_files/947ceaca5273a4f6f60883f985088401_hd.jpg" class="origin_image zh-lightbox-thumb lazy" width="692" alt="" style="overflow: hidden; display: block; max-width: 100%; margin: 0px auto">
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">图：服务端收到的信息</span></p>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">客户端收到服务端回射的消息后，也会显示出来，如下图所示。</span></p>
<img src="./LuaFramework 实战 - 田树东 - 博客园_files/40269145795aa3ee521986ea8cfe5ae0_hd.jpg" class="origin_image zh-lightbox-thumb lazy" width="692" alt="" style="overflow: hidden; display: block; max-width: 100%; margin: 0px auto">
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">图：客户端收到的消息</span></p>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">在<b style="color:black;background-color:#ffff66">lua</b>中调用networkMgr:SendMessage(buffer)时，实际上相当于调用了SocketClient的WriteMessage方法，该方法会计算协议的长度，然后将长度和内容组装在一起，调用BeginWrite发送数据。</span></p>
<img src="./LuaFramework 实战 - 田树东 - 博客园_files/cd0b7cca8c01cf8c6371f9bb7a5b7819_hd.jpg" class="origin_image zh-lightbox-thumb lazy" width="815" alt="" style="overflow: hidden; display: block; max-width: 100%; margin: 0px auto">
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">图：发送数据</span></p>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">在建立连接后，SocketClient会调用BeginRead，当收到服务端的消息时，回调OnRead方法。OnRead又调用了OnReceive方法。</span></p>
<img src="./LuaFramework 实战 - 田树东 - 博客园_files/2e0123ac24e8d0ae5724acf5d44dc200_hd.jpg" class="origin_image zh-lightbox-thumb lazy" width="787" alt="" style="overflow: hidden; display: block; max-width: 100%; margin: 0px auto">
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">图：接收数据过程</span></p>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">OnReceive方法完成沾包分包处理，然后调用AddEvent方法分发消息（相当于调用了<b style="color:black;background-color:#ffff66">lua</b>中NetWork表的OnSocket方法）。</span></p>
<img src="./LuaFramework 实战 - 田树东 - 博客园_files/85445982d44f9297809976c7b4ab10ac_hd.jpg" class="origin_image zh-lightbox-thumb lazy" width="692" alt="" style="overflow: hidden; display: block; max-width: 100%; margin: 0px auto">
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">图：解析数据过程</span></p>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">关于BeginRead、BeginConnect等方法的介绍，读者可以查看c#网络编程的资料或参照《Unity3D网络游戏<b style="color:black;background-color:#99ff99">实战</b>》第6章“网络基础”。</span></p>
<h2 style="margin: 20px 0px; font-weight: 400; line-height: inherit; color: rgb(51,51,51)">
<span style="font-size: 12px">3、<span style="font-weight: 600">消息分发</span></span></h2>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">一款游戏往往涉及很多条网络通信协议，在Network.OnSocket中，如果只用ifelse语句处理不同协议，代码往往会混乱不堪。LuaFramework集成了消息分发的方法，用法如下所示。</span></p>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">1、引用LuaFramework\<b style="color:black;background-color:#ffff66">Lua</b>\events.<b style="color:black;background-color:#ffff66">lua</b>，然后使用Event.AddListener添加监听，例如“Event.AddListener(Protocal.Connect, Network.OnConnect); ”表示当收到101协议（Protocal.Connect）时，回调Network.OnConnect方法。Main.<b style="color:black;background-color:#ffff66">lua</b>代码如下：</span></p>
<div class="highlight">
<pre style="margin-top: 1em; margin-bottom: 1em; padding: 10px; overflow: auto; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; background-color: rgb(246,246,246)"><code class="language-text" style="margin: 0px; padding: 0px; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace"><span style="font-size: 12px"><span></span>require "Network"
Event = require 'events'
 
--主入口函数。从这里开始<b style="color:black;background-color:#ffff66">lua</b>逻辑
function Main()		
	local LuaHelper = LuaFramework.LuaHelper
	local networkMgr = LuaHelper.GetNetManager()
	local AppConst = LuaFramework.AppConst
	
    AppConst.SocketPort = 1234;
    AppConst.SocketAddress = "127.0.0.1";
	
	Event.AddListener(Protocal.Connect, Network.OnConnect); 
    Event.AddListener(Protocal.Message, Network.OnMessage); 
	
	networkMgr:SendConnect();
end
</span></code></pre>
</div>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">2、在需要分发消息的地方调用Event.Brocast，然后编写相应的回调函数。Network.<b style="color:black;background-color:#ffff66">lua</b>的部分代码如下：</span></p>
<div class="highlight">
<pre style="margin-top: 1em; margin-bottom: 1em; padding: 10px; overflow: auto; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; background-color: rgb(246,246,246)"><code class="language-text" style="margin: 0px; padding: 0px; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace"><span style="font-size: 12px"><span></span>--Socket消息--
function Network.OnSocket(key, data)
	LuaFramework.Util.Log('OnSocket 消息分发:'..key);
	Event.Brocast(tostring(key), data);
end
 
function Network.OnConnect(data) 
    LuaFramework.Util.Log('Network.OnConnect');	
	Send()
end
 
function Network.OnMessage(data) 
    LuaFramework.Util.Log('Network.OnMessage');
	local str = data:ReadString();
	LuaFramework.Util.Log('收到的字符串：'..str);
end
</span></code></pre>
</div>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">运行游戏，可以看到消息分发的结果。</span></p>
<img src="./LuaFramework 实战 - 田树东 - 博客园_files/b28c0e5b4ce2c18588df29a89c5f4767_hd.jpg" class="origin_image zh-lightbox-thumb lazy" width="692" alt="" style="overflow: hidden; display: block; max-width: 100%; margin: 0px auto">
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">图：消息分发</span></p>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">调用Event.AddListener，实际上是在一个表中添加数据，把某个协议号对应于某个方法的信息记录起来。</span></p>
<img src="./LuaFramework 实战 - 田树东 - 博客园_files/d03f55260f7f95444d3c780d837d366d_hd.jpg" class="origin_image zh-lightbox-thumb lazy" width="604" alt="" style="overflow: hidden; display: block; max-width: 100%; margin: 0px auto">
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">图：AddListener的过程</span></p>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">当调用Event.Brocast时，程序会查找这份表，然后执行回调方法。这里使用了协程来调用回调函数。使用协程的目的应该是不让回调逻辑阻碍主体逻辑，然而由于协程是单线程的，这点不起作用。除非回调函数也使用协程，相互配合。所以这里应该可以不用协程的。</span></p>
<img src="./LuaFramework 实战 - 田树东 - 博客园_files/57406371f5ba45d25e63d5e2e69da555_hd.jpg" class="origin_image zh-lightbox-thumb lazy" width="693" alt="" style="overflow: hidden; display: block; max-width: 100%; margin: 0px auto">
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">图：Brocast的过程</span></p>
<p><span style="font-size: 12px"><br>
</span></p>
<p></p>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">LuaFramework使用了PureMVC框架。百度百科上说：“PureMVC是在基于模型、视图和控制器MVC模式建立的一个轻量级的应用框架”。PureMVC框架可以做到较好的解耦，减少游戏代码的相互调用。然而LuaFramework整合PureMVC属于“杀鸡用牛刀”，实质上只用到了事件分发（也可能是我理解得不够透彻）。如果单纯写一套事件分发系统，可能不到100行代码就能完成。</span></p>
<h2 style="margin: 20px 0px; font-weight: 400; line-height: inherit; color: rgb(51,51,51)">
<span style="font-size: 12px">1、<span style="font-weight: 600">解耦的好处</span></span></h2>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">如果没有很好的解耦设计，游戏功能越多，代码就越乱，最后没人敢改动。举个例子，假如游戏中背包（item）和成就（Achieve）两项功能，各用一个类实现。当玩家获得100个经验豆（一种道具）时，会获得“拥有100个经验豆”的成就；当成就点数达到300时，会获得道具奖励。一种常见的实现方法是调用对方的public函数，代码如下所示。然而如果一款游戏有几百上千个类，之间又相互调用，如果某些功能需要大改（例如删掉成就功能），那其他的类也得改动。</span></p>
<div class="highlight">
<pre style="margin-top: 1em; margin-bottom: 1em; padding: 10px; overflow: auto; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; background-color: rgb(246,246,246)"><code class="language-text" style="margin: 0px; padding: 0px; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace"><span style="font-size: 12px"><span></span>Class Item
{
    public AddItem()
    {
        if(经验豆 &gt; 100)
            achieve.AddAchieve(“拥有100个经验豆”)
    }
}
 
Class Achieve
{
    public AddAchieve()
    {
        成就点数 + 10
        if(成就点数 &gt; 300)
            item.AddItem(宝石)
    }
}
</span></code></pre>
</div>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">如果使用事件分发，各个类之间的联系就减弱了。如下所示的代码中背包类（Item）监听了消息“添加道具”，成就类（Achieve）监听了消息“添加成就”。如果达成成就需要添加奖励，只需派发“添加道具”这条消息，由背包类去执行。这样类与类之间不存在相互调用，就算大改功能甚至删掉功能，其他类都受到的影响比较小。</span></p>
<div class="highlight">
<pre style="margin-top: 1em; margin-bottom: 1em; padding: 10px; overflow: auto; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; background-color: rgb(246,246,246)"><code class="language-text" style="margin: 0px; padding: 0px; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace"><span style="font-size: 12px"><span></span>Class Item
{
    Start()
    {
         监听(“添加道具”,AddItem)
    }

    private AddItem()
    {
        if(经验豆 &gt; 100)
            分发(“添加成就”,“拥有100个经验豆”)
    }
}
 
Class Achieve
{
    Start()
    {
         监听(“添加成就”,AddAchieve)
    }
 
    private AddAchieve()
    {
        成就点数 + 10
        If(成就点数 &gt; 300)
            分发(“添加道具”, 宝石)
    }
}
</span></code></pre>
</div>
<span style="font-size: 12px"><br style="color: rgb(51,51,51)">
</span>
<h2 style="margin: 20px 0px; font-weight: 400; line-height: inherit; color: rgb(51,51,51)">
<span style="font-weight: 600"><span style="font-size: 12px">2、MVC的使用方法</span></span></h2>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">LuaFramework中的Framwork目录存放着PureMVC框架的代码，个人认为在LuaFramework中属于过度设计（毕竟从其他地方拷过来的）。它的原理并不复杂，用一个列表把监听信息保存起来，在派发消息时，查找对应的监听表，找到需要回调的对象。</span></p>
<img src="./LuaFramework 实战 - 田树东 - 博客园_files/7457673a9898da3418eedcdde84f471d_hd.jpg" class="content_image lazy" width="409" alt="" style="overflow: hidden; display: block; max-width: 100%; margin: 0px auto">
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">PureMVC框架便是实现了“注册/分发”模式（发布/订阅、观察者模式），可以调用RegisterCommand注册消息（命令），调用SendMessageCommand方法分发消息。RegisterCommand方法可以把某个继承ControllerCommand 的类注册到指定的消息下，在事件分发时调用该类的Execute方法。</span></p>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">例如新建一个名为TestCommand的类，让它继承ControllerCommand，然后编写Execute方法处理具体事务。</span></p>
<div class="highlight">
<pre style="margin-top: 1em; margin-bottom: 1em; padding: 10px; overflow: auto; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; background-color: rgb(246,246,246)"><code class="language-text" style="margin: 0px; padding: 0px; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace"><span style="font-size: 12px"><span></span>using UnityEngine;
using System.Collections;
 
public class TestCommand : ControllerCommand 
{
	public override void Execute(IMessage message) 
	{
		Debug.Log("name=" + message.Name);
		Debug.Log("type=" + message.Type);
	}
}
</span></code></pre>
</div>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">接着，编写另一个类来处理消息。这个类先调用AppFacade.Instance.RegisterCommand()将TestCommand类注册到“TestMessage”消息下。然后使用SendMessageCommand()派发“TestMessage”消息。框架将会创建一个TestCommand实例，并调用它的Execute方法。</span></p>
<div class="highlight">
<pre style="margin-top: 1em; margin-bottom: 1em; padding: 10px; overflow: auto; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; background-color: rgb(246,246,246)"><code class="language-text" style="margin: 0px; padding: 0px; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace"><span style="font-size: 12px"><span></span>public class Main : MonoBehaviour 
{
        void Start() 
	{
		AppFacade.Instance.RegisterCommand ("TestMessage", 
							typeof(TestCommand));
		AppFacade.Instance.SendMessageCommand ("TestMessage");
        }
}
</span></code></pre>
</div>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">运行结果如下所示，可以看到分发消息后，TestCommand的Execute方法被调用。</span></p>
<img src="./LuaFramework 实战 - 田树东 - 博客园_files/407d897f18324cf6c4bd4d2ce8402877_hd.jpg" class="content_image lazy" width="320" alt="" style="overflow: hidden; display: block; max-width: 100%; margin: 0px auto">
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">Execute方法的参数message包含了Name,Body,Type三个成员（如下图所示）。其中Name是命令名，Body是一个任意类型的参数。</span></p>
<img src="./LuaFramework 实战 - 田树东 - 博客园_files/86c1aaa05182f14caf0db8301e0b2d79_hd.jpg" class="content_image lazy" width="355" alt="" style="overflow: hidden; display: block; max-width: 100%; margin: 0px auto">
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">如下代码所示，在SendMessageCommand中可以给消息的Body传值，相应的Execute方法便可以获取它。</span></p>
<div class="highlight">
<pre style="margin-top: 1em; margin-bottom: 1em; padding: 10px; overflow: auto; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; background-color: rgb(246,246,246)"><code class="language-text" style="margin: 0px; padding: 0px; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace"><span style="font-size: 12px"><span></span>void Start() 
{
	AppFacade.Instance.RegisterCommand ("TestMessage", 
							typeof(TestCommand));
	AppFacade.Instance.SendMessageCommand ("TestMessage", "这是字符串");
}
</span></code></pre>
</div>
<span style="font-size: 12px"><br style="color: rgb(51,51,51)">
</span>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">运行结果如下图所示。</span></p>
<img src="./LuaFramework 实战 - 田树东 - 博客园_files/0c5ba3c4c40fb2e3acb03eebe4d1893b_hd.jpg" class="content_image lazy" width="297" alt="" style="overflow: hidden; display: block; max-width: 100%; margin: 0px auto">
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">总而言之，LuaFramework中所谓的pureMVC只是一套“注册/分发”机制，完全可以用c#的事件来实现。另《Unity3D网络游戏<b style="color:black;background-color:#99ff99">实战</b>》中的客户端网络模块部分也使用的“注册/分发”机制，有兴趣的读者可以看看。</span></p>
<h2 style="margin: 20px 0px; font-weight: 400; line-height: inherit; color: rgb(51,51,51)">
<span style="font-weight: 600"><span style="font-size: 12px">3、MVC与Unity3D组件的结合</span></span></h2>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">pureMVC与Unity3D组件之间有一些封装，只要让组件继承View类（View类继承MonoBehavior），即使用pureMVC框架的RegisterMessage和SendMessageComman方法实现“注册/分发”机制。</span></p>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">例如，新建一个继承自View的TestManage组件，在Start 方法中它注册了“msg1”、“msg2”、“msg3”三个消息的监听。在Update方法中，当按下空格键时，分发消息“msg1”。</span></p>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">当接收到消息后，指定对象（这里指定this）的OnMessage方法会被调用，参数message里面包含了命令名、Body等信息。代码如下所示。</span></p>
<div class="highlight">
<pre style="margin-top: 1em; margin-bottom: 1em; padding: 10px; overflow: auto; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; background-color: rgb(246,246,246)"><code class="language-text" style="margin: 0px; padding: 0px; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace"><span style="font-size: 12px"><span></span>using UnityEngine;
using System.Collections;
using System.Collections.Generic;
 
public class TestManage : View 
{
 
	// Use this for initialization
	void Start () 
	{
		List&lt;string&gt; regList = new List&lt;string&gt;();
		regList.Add("msg1");
		regList.Add("msg2");
		regList.Add("msg3");
 
		RegisterMessage(this,regList);
	}
	
	// Update is called once per frame
	void Update () 
	{
		if (Input.GetKeyUp (KeyCode.Space)) 
		{
			facade.SendMessageCommand("msg1", null);
		}
	}
 
	public override void OnMessage(IMessage message) 
	{
		Debug.Log ("OnMessage " + message.Name);
	}
}
</span></code></pre>
</div>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">此外LuaFramework的各个Manager（如GameManager，LuaManager，SoundManager等）也都继承自View类，可以使用“注册/分发”机制。</span></p>
<p></p>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">LuaFramework内置的管理器包括GameManager（处理热更新）、luaManager（<b style="color:black;background-color:#ffff66">lua</b>脚本管理器）、PanelManager（界面管理器）、NetworkManager（网络管理器）、ResourceManager（资源管理器）、TimerManager（时间管理器）、线程管理器（ThreadManager）和SoundManager（声音管理器）。其中GameManager、luaManager、PanelManager、NetworkManager、ResourceManager在前面的文章中已经有过介绍，这一篇讲讲讲播放声音相关的SoundManager。</span></p>
<h2 style="margin: 20px 0px; font-weight: 400; line-height: inherit; color: rgb(51,51,51)">
<span style="font-weight: 600"><span style="font-size: 12px">1、使用方法</span></span></h2>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">SoundManager估计是从其他地方拷过来的，并不能很好的与框架结合，这里我们先看看原来的SoundManager的使用方法，再介绍它的不足之处及改进方法。虽然SoundManager定义了好几个方法，但能直接在<b style="color:black;background-color:#ffff66">lua</b>中使用的只有用于播放背景音乐的PlayBacksound。</span></p>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">编写播放声音的代码前，需要在GameManager上挂载AudioSource组件，以播放背景音乐。</span></p>
<img src="./LuaFramework 实战 - 田树东 - 博客园_files/ae823f297d76c1d6399d3ed43b82450f_hd.jpg" class="origin_image zh-lightbox-thumb lazy" width="474" alt="" style="overflow: hidden; display: block; max-width: 100%; margin: 0px auto">
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">把声音文件放到Resource目录下，由于SoundManager使用Resources.Load加载声音文件，声音文件必须放到这个目录下。如下图所示。</span></p>
<img src="./LuaFramework 实战 - 田树东 - 博客园_files/f1ac8139a5f24ac3ddb9f1259aaf6d77_hd.jpg" class="content_image lazy" width="172" alt="" style="overflow: hidden; display: block; max-width: 100%; margin: 0px auto">
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">然后编写<b style="color:black;background-color:#ffff66">lua</b>代码，调用soundMgr:PlayBacksound即可，它的第一个参数指明Resource目录下的文件名，第二个参数为true表示开始播放，false表示停止播放。</span></p>
<div class="highlight">
<pre style="margin-top: 1em; margin-bottom: 1em; padding: 10px; overflow: auto; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; background-color: rgb(246,246,246)"><code class="language-text" style="margin: 0px; padding: 0px; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace"><span style="font-size: 12px"><span></span>--主入口函数。从这里开始<b style="color:black;background-color:#ffff66">lua</b>逻辑
function Main()					
	LuaHelper = LuaFramework.LuaHelper;
	soundMgr = LuaHelper.GetSoundManager();
	soundMgr:PlayBacksound("motor", true)
end
</span></code></pre>
</div>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">运行游戏，即可听到音效。关于Unity3D播放声音的内容，大家也可以参考《Unity3D网络游戏<b style="color:black;background-color:#99ff99">实战</b>》哦！</span></p>
<h2 style="margin: 20px 0px; font-weight: 400; line-height: inherit; color: rgb(51,51,51)">
<span style="font-size: 12px">2、<span style="font-weight: 600">代码解析</span></span></h2>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">SoundManager的示意代码如下，实际上是使用Resources.Load来加载资源的，所以声音文件必须放在Resources目录下。</span></p>
<img src="./LuaFramework 实战 - 田树东 - 博客园_files/a2359f576580a4d7bd7bec7e9eca27eb_hd.jpg" class="origin_image zh-lightbox-thumb lazy" width="679" alt="" style="overflow: hidden; display: block; max-width: 100%; margin: 0px auto">
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">这种用法违背了热更新框架的设计，因为在Resources目录下的文件并不能热更。</span></p>
<h2 style="margin: 20px 0px; font-weight: 400; line-height: inherit; color: rgb(51,51,51)">
<span style="font-weight: 600"><span style="font-size: 12px">3、改进的声音管理器</span></span></h2>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">这一部分我们需要改进声音管理器，实现这么几个功能：</span></p>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">1）从本地“数据目录”读取打包后的声音文件，使它支持热更新；</span></p>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">2）添加播放/停止背景音乐的PlayBackSound/StopBackSound和播放音效的PlaySound方法；</span></p>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">3）使用缓存存储加载后的声音文件，以提高运行效率。</span></p>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">为了支持加载AudioClip的加载，在ResourceManager中添加LoadAudioClip方法，该方法将会加载资源包abName的资源assetName，加载完AudioClip资源后调用回调函数func，代码如下。</span></p>
<div class="highlight">
<pre style="margin-top: 1em; margin-bottom: 1em; padding: 10px; overflow: auto; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; background-color: rgb(246,246,246)"><code class="language-text" style="margin: 0px; padding: 0px; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace"><span style="font-size: 12px"><span></span>//载入音效资源
public void LoadAudioClip(string abName, 
                                  string assetName, Action&lt;UObject[]&gt; func) 
{
	LoadAsset&lt;AudioClip&gt;(abName, new string[] { assetName }, func);
}
</span></code></pre>
</div>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">修改SoundManager，使用Hashtable类型的sounds存储加载后的声音，包含PlayBackSound、StopBackSound和PlaySound三个API。代码如下所示。</span></p>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">先是整体kuan</span></p>
<div class="highlight">
<pre style="margin-top: 1em; margin-bottom: 1em; padding: 10px; overflow: auto; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; background-color: rgb(246,246,246)"><code class="language-text" style="margin: 0px; padding: 0px; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace"><span style="font-size: 12px"><span></span>using UnityEngine;
using System.Collections;
using System.Collections.Generic;
 
namespace LuaFramework 
{
    public class SoundManager : Manager 
    {
	private AudioSource audio;
	private Hashtable sounds = new Hashtable();
	string backSoundKey = "";
 
	void Start() 
	{
		audio = GetComponent&lt;AudioSource&gt;();
		if (audio == null)
			gameObject.AddComponent&lt;AudioSource&gt; ();
	}
 
	//回调函数原型
	private delegate void GetBack(AudioClip clip, string key);
 
	//获取声音资源
	private void Get(string abName, string assetName, GetBack cb)
	{
		string key = abName + "." + assetName;
		if(sounds [key] == null) 
		{
			ResManager.LoadAudioClip(abName, assetName, (objs)=&gt;
			{
				if(objs == null || objs[0] == null)
				{
					Debug.Log("PlayBackSound fail);
					cb(null,key);
					return;
				}
				else
				{
					sounds.Add(key, objs[0]);
					cb(objs[0] as AudioClip ,key);
					return;
				}
			});
		} 
		else 
		{
			cb(sounds [key] as AudioClip,key);
			return;
		}
	}
  }
}
</span></code></pre>
</div>
<span style="font-size: 12px"><br style="color: rgb(51,51,51)">
</span>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">PlayBackSound：</span></p>
<div class="highlight">
<pre style="margin-top: 1em; margin-bottom: 1em; padding: 10px; overflow: auto; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; background-color: rgb(246,246,246)"><code class="language-text" style="margin: 0px; padding: 0px; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace"><span style="font-size: 12px"><span></span>	//播放背景音乐
	public void PlayBackSound(string abName, string assetName)
	{
		backSoundKey = abName + "." + assetName;
		Get(abName, assetName,(clip, key)=&gt;
		{
			if(clip == null)
				return;
			if(key != backSoundKey)
				return;
 
			audio.loop = true;
			audio.clip = clip;
			audio.Play();
		});
	}
</span></code></pre>
</div>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">StopBackSound：</span></p>
<div class="highlight">
<pre style="margin-top: 1em; margin-bottom: 1em; padding: 10px; overflow: auto; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; background-color: rgb(246,246,246)"><code class="language-text" style="margin: 0px; padding: 0px; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace"><span style="font-size: 12px"><span></span>	//停止背景音乐
	public void StopBackSound()
	{
		backSoundKey = "";
		audio.Stop ();
	}
</span></code></pre>
</div>
<span style="font-size: 12px"><br style="color: rgb(51,51,51)">
</span>
<div class="highlight">
<pre style="margin-top: 1em; margin-bottom: 1em; padding: 10px; overflow: auto; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; background-color: rgb(246,246,246)"><code class="language-text" style="margin: 0px; padding: 0px; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace"><span style="font-size: 12px"><span></span> 	//播放音效
	public void PlaySound(string abName, string assetName)
	{
		Get(abName, assetName,(clip, key)=&gt;
		{
 
			if(clip == null)
				return;
			if(Camera.main == null)
				return;
		AudioSource.PlayClipAtPoint(clip, 
					Camera.main.transform.position); 
		});
	}
</span></code></pre>
</div>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">修改代码后，需要重新生成wrap文件（点击菜单栏的<b style="color:black;background-color:#ffff66">Lua</b>→Clear wrap files和<b style="color:black;background-color:#ffff66">Lua</b>→Generate All）。然后编写<b style="color:black;background-color:#ffff66">lua</b>代码调试它吧！这里演示的是先播放背景音乐，3秒后停止播放，每隔0.3秒播放一次音效的功能。</span></p>
<div class="highlight">
<pre style="margin-top: 1em; margin-bottom: 1em; padding: 10px; overflow: auto; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; background-color: rgb(246,246,246)"><code class="language-text" style="margin: 0px; padding: 0px; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace"><span style="font-size: 12px"><span></span>--主入口函数。从这里开始<b style="color:black;background-color:#ffff66">lua</b>逻辑
function Main()					
	LuaHelper = LuaFramework.LuaHelper;
	soundMgr = LuaHelper.GetSoundManager();
	soundMgr:PlayBackSound("sound", "motor")
	UpdateBeat:Add(Update, self)
end
 
 
local lastTime = 0
 
function Update()
	if Time.time &gt; 3 then
		soundMgr:StopBackSound();
	end
	
	
	if Time.time - lastTime &gt; 0.3 then
		soundMgr:PlaySound("sound", "shoot")
		lastTime = Time.time
	end
end
</span></code></pre>
<div><code class="language-text" style="margin: 0px; padding: 0px; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace"><span style="font-size: 12px"><br>
</span></code></div>
</div>
<p></p>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"></p>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)">LuaFramework内置了线程管理器ThreadManager，一开始我以为这是个创建线程、终止线程等方法的封装。然而不是，它是热更新时使用线程下载资源的具体实现。那让我们来看看线程管理器的工作原理吧。</p>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)">@罗培羽</p>
<h2 style="margin: 20px 0px; font-size: 24px; font-weight: 400; line-height: inherit; color: rgb(51,51,51)">
1、GameManager的调用</h2>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)">那么先看看在热更新过程中哪些地方调用到ThreadManager。热更新由GameManager执行（相关代码如下图所示），它在对比本地文件和网络资源的差异后，将需要下载的文件名存放到列表中，然后遍历列表，调用BeginDownload下载。从代码可以看出，它通过ISDownOK判断该文件是否下载完成，然后下载下一个文件，一个个的下载文件。</p>
<img src="./LuaFramework 实战 - 田树东 - 博客园_files/v2-9d57777f2083222ec6aa2bda6504025a_hd.jpg" class="origin_image zh-lightbox-thumb lazy" width="692" alt="" style="overflow: hidden; display: block; max-width: 100%; margin: 0px auto">
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)">BeginDownload（代码如下所示）便调用ThreadManager的AddEvent方法。ThreadManager并不是真正意义上的线程管理器，它只管理一条“下载线程”，通过AddEvent将要下载的文件名放到“代办列表”中，该线程依次下载它们。其中的OnThreadCompleted是“回调函数”，在下载该文件后，会通过消息的方式回调它。</p>
<img src="./LuaFramework 实战 - 田树东 - 博客园_files/v2-063218879a948bcf6b58df897c65d2f8_hd.jpg" class="origin_image zh-lightbox-thumb lazy" width="663" alt="" style="overflow: hidden; display: block; max-width: 100%; margin: 0px auto">
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)">在“下载线程”下载完一个文件后，它以通知的形式调用“回调函数”OnThreadCompleted（代码如下所示），该方法将会设置“下载完成列表”downloadFiles。</p>
<img src="./LuaFramework 实战 - 田树东 - 博客园_files/v2-bc9d1608779b5a8e0c52fb864c71f7d2_hd.jpg" class="origin_image zh-lightbox-thumb lazy" width="604" alt="" style="overflow: hidden; display: block; max-width: 100%; margin: 0px auto">
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)">再看看IsDownOk（代码如下所示）方法，当“下载完成列表”包含该文件时，说明下载已经完成，可以进行下一个文件的下载。</p>
<img src="./LuaFramework 实战 - 田树东 - 博客园_files/v2-c5246dcbef061ee5be76bef416ef31f7_hd.jpg" class="origin_image zh-lightbox-thumb lazy" width="429" alt="" style="overflow: hidden; display: block; max-width: 100%; margin: 0px auto">
<h2 style="margin: 20px 0px; font-size: 24px; font-weight: 400; line-height: inherit; color: rgb(51,51,51)">
2、ThreadManager的启动</h2>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)">ThreadManager启动时，开启一个线程“下载线程”，相关代码如下所示。由此ThreadManager仅仅是管理一条线程，而不是真正意义的线程管理器。</p>
<img src="./LuaFramework 实战 - 田树东 - 博客园_files/v2-ca7ca068f4bd3b9db078d86c94c6a35c_hd.jpg" class="origin_image zh-lightbox-thumb lazy" width="437" alt="" style="overflow: hidden; display: block; max-width: 100%; margin: 0px auto"><img src="./LuaFramework 实战 - 田树东 - 博客园_files/v2-8f440fdb7b832b13c1b6f2cfd85a49ba_hd.jpg" class="origin_image zh-lightbox-thumb lazy" width="610" alt="" style="overflow: hidden; display: block; max-width: 100%; margin: 0px auto"><br style="color: rgb(51,51,51)">
<h2 style="margin: 20px 0px; font-size: 24px; font-weight: 400; line-height: inherit; color: rgb(51,51,51)">
3、AddEvent方法</h2>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)">AddEvent是给线程添加任务的方法，代码如下，其实就是给events队列添加一个值。</p>
<img src="./LuaFramework 实战 - 田树东 - 博客园_files/v2-9c070f5ecfffe553c27ef51fdace5300_hd.jpg" class="origin_image zh-lightbox-thumb lazy" width="639" alt="" style="overflow: hidden; display: block; max-width: 100%; margin: 0px auto">
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)">Events的定义如下所示：</p>
<img src="./LuaFramework 实战 - 田树东 - 博客园_files/v2-8f440fdb7b832b13c1b6f2cfd85a49ba_hd.jpg" class="origin_image zh-lightbox-thumb lazy" width="610" alt="" style="overflow: hidden; display: block; max-width: 100%; margin: 0px auto">
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)">ThreadEvent包含事件名key和参数evParams，代码如下所示。</p>
<img src="./LuaFramework 实战 - 田树东 - 博客园_files/v2-6eeb42027aff6c71cd301bbed0da3651_hd.jpg" class="origin_image zh-lightbox-thumb lazy" width="558" alt="" style="overflow: hidden; display: block; max-width: 100%; margin: 0px auto">
<h2 style="margin: 20px 0px; font-size: 24px; font-weight: 400; line-height: inherit; color: rgb(51,51,51)">
3、下载过程</h2>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)">“下载线程”执行了OnUpdate方法（代码如下所示），它调用OnDownloadFile下载文件。</p>
<img src="./LuaFramework 实战 - 田树东 - 博客园_files/v2-2f8590078893bd1861f51803896f850e_hd.jpg" class="origin_image zh-lightbox-thumb lazy" width="692" alt="" style="overflow: hidden; display: block; max-width: 100%; margin: 0px auto">
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)">OnDownloadFile（代码如下所示）又调用了DownloadFileAsync下载文件，下载文件过程中ProgressChanged方法会被调用。</p>
<img src="./LuaFramework 实战 - 田树东 - 博客园_files/v2-bf56e7215cb05200be9957c756330c48_hd.jpg" class="origin_image zh-lightbox-thumb lazy" width="692" alt="" style="overflow: hidden; display: block; max-width: 100%; margin: 0px auto">
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)">ProgressChanged方法记录了下载进度，当进度为100%时，使用m_SyncEvent发送通知，相当于调用“回调函数”OnThreadCompleted。</p>
<img src="./LuaFramework 实战 - 田树东 - 博客园_files/v2-582eacd240acad3e08aca6fc9fbc7502_hd.jpg" class="origin_image zh-lightbox-thumb lazy" width="692" alt="" style="overflow: hidden; display: block; max-width: 100%; margin: 0px auto"><br style="color: rgb(51,51,51)">
<h2 style="margin: 20px 0px; font-size: 24px; font-weight: 400; line-height: inherit; color: rgb(51,51,51)">
4、改进</h2>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)">这套线程管理器依然有“杀鸡用牛刀”之嫌，“任务列表”并没有实际作用（因为GameManager控制了下载进度，一个个下载），消息分发部分也太复杂，实际上只用回调函数之类的方法便能够实现。</p>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)">个人认为线程管理器应当提供线程调度的方法，具体的下载逻辑可在GameManager中实现。而且下载功能不一定非要用线程，协程也能够解决，而且更简单。代码如下所示。</p>
<img src="./LuaFramework 实战 - 田树东 - 博客园_files/v2-ea1653624932b1882e6465d10afd8932_hd.jpg" class="origin_image zh-lightbox-thumb lazy" width="545" alt="" style="overflow: hidden; display: block; max-width: 100%; margin: 0px auto">
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)">由于热更新需要下载不少的文件，一个个下载实在太慢。如果能开启多个线程，同时下载，可在一定程度上提高下载速度。</p>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)">框架并没有处理下载失败的情况，一般情况下，当一个文件下载失败，应当重试，在重试多次依然无法下载时，才弹出错误。</p>
<br>
<p><span style="font-size: 12px"><br>
</span></p>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">终于到了本系列完结的时候了。</span></p>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">现在，大家对LuaFramework有个全方位的理解了吧！接下来通过一个例子总结ulua，作为“<b style="color:black;background-color:#ffff66">lua</b>逻辑”的延伸，说明<b style="color:black;background-color:#ffff66">lua</b>的写法。这个例子中玩家能够控制2D游戏角色走动，并且发射炮弹。</span></p>
<h2 style="margin: 20px 0px; font-weight: 400; line-height: inherit; color: rgb(51,51,51)">
<span style="font-size: 12px">1、目标</span></h2>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">制作如图所示的游戏，玩家可以通过键盘控制角色上下左右移动，角色有4个面向，走动过程中会播放行走动画。当玩家点击鼠标左键，角色会发射一颗炮弹。</span></p>
<img src="./LuaFramework 实战 - 田树东 - 博客园_files/v2-0bba3766f7cec9f313c7ab33f7884ba1_hd.jpg" class="origin_image zh-lightbox-thumb lazy" width="564" alt="" style="overflow: hidden; display: block; max-width: 100%; margin: 0px auto">
<h2 style="margin: 20px 0px; font-weight: 400; line-height: inherit; color: rgb(51,51,51)">
<span style="font-size: 12px">2、游戏资源</span></h2>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">使用下图所示的图片作为游戏角色（该图片来自rpg maker），在导入Unity后将它切割成12张小图。</span></p>
<img src="./LuaFramework 实战 - 田树东 - 博客园_files/v2-af9202869962d34cc68c372bee35b3ab_hd.jpg" class="content_image lazy" width="180" alt="" style="overflow: hidden; display: block; max-width: 100%; margin: 0px auto"><img src="./LuaFramework 实战 - 田树东 - 博客园_files/v2-0f279583ad93f319fc86b1c5c2e9e5b8_hd.jpg" class="origin_image zh-lightbox-thumb lazy" width="692" alt="" style="overflow: hidden; display: block; max-width: 100%; margin: 0px auto"><span style="font-size: 12px"><br style="color: rgb(51,51,51)">
</span>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">使用如下图所示的图片作为炮弹。</span></p>
<img src="./LuaFramework 实战 - 田树东 - 博客园_files/v2-b4c8d9ee317d96d6f2e6241ee6c7c9b3_hd.jpg" class="content_image lazy" width="62" alt="" style="overflow: hidden; display: block; max-width: 100%; margin: 0px auto">
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">在游戏场景中新建画布，画布下摆放一个名为Panel的面板，代表游戏场景。面板下有res和map两个子物体，map（Image）为一张场景图，role（Image）为游戏中的角色，bullet（Image）为游戏中的子弹（同一时间只能发射一颗子弹）。</span></p>
<img src="./LuaFramework 实战 - 田树东 - 博客园_files/v2-b6330f39ed56c89b5f1128a6c9022240_hd.jpg" class="origin_image zh-lightbox-thumb lazy" width="692" alt="" style="overflow: hidden; display: block; max-width: 100%; margin: 0px auto">
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">Res子物体存放12张角色图片（Image），之后会使用这些资源替换map.role的图片，以实现动画效果。</span></p>
<img src="./LuaFramework 实战 - 田树东 - 博客园_files/v2-f53120ba92a23e4f3006142a48d51fb7_hd.jpg" class="origin_image zh-lightbox-thumb lazy" width="692" alt="" style="overflow: hidden; display: block; max-width: 100%; margin: 0px auto">
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">然后将Panel做成预设，存放到SimpleGame目录下。并且在GameManager空物体上添加Game组件，以启动框架。</span></p>
<img src="./LuaFramework 实战 - 田树东 - 博客园_files/v2-8ab8581422cb2354e8ea13bd4ac254b4_hd.jpg" class="origin_image zh-lightbox-thumb lazy" width="693" alt="" style="overflow: hidden; display: block; max-width: 100%; margin: 0px auto">
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">修改Packager.cs，在HandleExampleBundle添加如下代码，将SimpleGame目录下的预设打包。然后点击LuaFramework→Build Windows Resource打包。</span></p>
<div class="highlight">
<pre style="margin-top: 1em; margin-bottom: 1em; padding: 10px; overflow: auto; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; background-color: rgb(246,246,246)"><code class="language-text" style="margin: 0px; padding: 0px; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace"><span style="font-size: 12px"><span></span>//小游戏
AddBuildMap("SimpleGame" + AppConst.ExtName, "*.prefab", "Assets/SimpleGame");
</span></code></pre>
</div>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">具体的框架设置请参加第一篇和第二篇，这里仅做简单描述。</span></p>
<h2 style="margin: 20px 0px; font-weight: 400; line-height: inherit; color: rgb(51,51,51)">
<span style="font-size: 12px">3、编写行走代码</span></h2>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">游戏使用UI组件，在CustomSettings.cs中添加如下两行，使tolua生成Image和Sprite相关的调用。</span></p>
<div class="highlight">
<pre style="margin-top: 1em; margin-bottom: 1em; padding: 10px; overflow: auto; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; background-color: rgb(246,246,246)"><code class="language-text" style="margin: 0px; padding: 0px; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace"><span style="font-size: 12px"><span></span>_GT(typeof(Image)),
_GT(typeof(Sprite)),
</span></code></pre>
</div>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">打开main.<b style="color:black;background-color:#ffff66">lua</b>（如何运行main.<b style="color:black;background-color:#ffff66">lua</b>请参见第一篇）开始编写代码。程序从Main方法开始执行，使用LoadPrefab（请参见第二篇）加载之前打包的资源文件Panel。这里还定义几个变量，其中map代表游戏场景（panel.map），role代表游戏角色（panel.map.role），roleImage是游戏角色中的图片组件，roleRes代表各个面向的角色图片，比如roleRes[“UP”]将会包含panel.res中3张角色朝上的图。roleAnm代表当前角色的动画，每个面向有3个动画，对应于不同的图片。lastAnmTime代表展现角色动画帧的时间，用于控制动画播放速度。</span></p>
<div class="highlight">
<pre style="margin-top: 1em; margin-bottom: 1em; padding: 10px; overflow: auto; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; background-color: rgb(246,246,246)"><code class="language-text" style="margin: 0px; padding: 0px; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace"><span style="font-size: 12px"><span></span>--主入口函数。从这里开始<b style="color:black;background-color:#ffff66">lua</b>逻辑
function Main()					
	LuaHelper = LuaFramework.LuaHelper;
	resMgr = LuaHelper.GetResManager();
	resMgr:LoadPrefab('SimpleGame', { 'Panel' }, OnLoadFinish);
end

local map
local role
local roleImage
local roleRes = {
	["UP"] = {},
	["DOWN"] = {},
	["LEFT"] = {},
	["RIGHT"] = {},
}
local roleAnm = 1;
local lastAnmTime = 0;

--加载完成后的回调--
function OnLoadFinish(objs)
    --暂略
end
</span></code></pre>
</div>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">接着编写加载完成的回调方法OnLoadFinish，它处理下面几件事情。</span></p>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">1、使用Instantiate实例化面板，并且设置面板的坐标，具体请参见第5篇。</span></p>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">2、获取面板中的部件，给map、role、roleImage赋值。</span></p>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">3、获取素材res中的图片，赋值给roleRes，之后roleRes ["UP"]，roleRes ["DOWN"]，roleRes ["LEFT"]，roleRes ["RIGHT"]都包含3张同面向不同动画的图片。</span></p>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">4、使用UpdateBeat:Add()初始化Update方法（具体参照第三篇）。</span></p>
<div class="highlight">
<pre style="margin-top: 1em; margin-bottom: 1em; padding: 10px; overflow: auto; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; background-color: rgb(246,246,246)"><code class="language-text" style="margin: 0px; padding: 0px; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace"><span style="font-size: 12px"><span></span>function OnLoadFinish(objs)
	--显示面板
	go = UnityEngine.GameObject.Instantiate(objs[0])
	local parent = UnityEngine.GameObject.Find("Canvas")
    go.transform:SetParent(parent.transform, false)
	--获取元素
	map = go.transform:FindChild("map").gameObject
	role = map.transform:FindChild("role").gameObject
	roleImage = role:GetComponent("Image")
	--获取素材
	local res = go.transform:FindChild("res").gameObject
	roleRes["DOWN"][1] = res.transform:FindChild("role (0)").gameObject:GetComponent("Image").sprite
	roleRes["DOWN"][2] = res.transform:FindChild("role (1)").gameObject:GetComponent("Image").sprite
	roleRes["DOWN"][3] = res.transform:FindChild("role (2)").gameObject:GetComponent("Image").sprite
	roleRes["LEFT"][1] = res.transform:FindChild("role (3)").gameObject:GetComponent("Image").sprite
	roleRes["LEFT"][2] = res.transform:FindChild("role (4)").gameObject:GetComponent("Image").sprite
	roleRes["LEFT"][3] = res.transform:FindChild("role (5)").gameObject:GetComponent("Image").sprite
	roleRes["RIGHT"][1] = res.transform:FindChild("role (6)").gameObject:GetComponent("Image").sprite
	roleRes["RIGHT"][2] = res.transform:FindChild("role (7)").gameObject:GetComponent("Image").sprite
	roleRes["RIGHT"][3] = res.transform:FindChild("role (8)").gameObject:GetComponent("Image").sprite
	roleRes["UP"][1] = res.transform:FindChild("role (9)").gameObject:GetComponent("Image").sprite
	roleRes["UP"][2] = res.transform:FindChild("role (10)").gameObject:GetComponent("Image").sprite
	roleRes["UP"][3] = res.transform:FindChild("role (11)").gameObject:GetComponent("Image").sprite
	--UpdateBeat
	UpdateBeat:Add(Update, self)
end
</span></code></pre>
</div>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">编写Update方法，它根据用户输入改变坐标（具体参见第三篇），并且根据不同的移动方向设置角色图片素材，将roleImage.sprite替换成roleRes[方向][动画索引]。最后判断“if Time.time - lastAnmTime &gt; 0.1 then”，每隔0.1秒切换一次动画。</span></p>
<div class="highlight">
<pre style="margin-top: 1em; margin-bottom: 1em; padding: 10px; overflow: auto; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; background-color: rgb(246,246,246)"><code class="language-text" style="margin: 0px; padding: 0px; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace"><span style="font-size: 12px"><span></span>--每帧执行
function Update()
	
	--移动
	local Input = UnityEngine.Input;
	local horizontal = Input.GetAxis("Horizontal");
	local verticla = Input.GetAxis("Vertical");
	
	local x = role.transform.position.x + horizontal
	local y = role.transform.position.y + verticla
	role.transform.position = Vector3.New(x,y,0)
	--转向
	if horizontal &lt; 0 then
		roleImage.sprite = roleRes["LEFT"][roleAnm]
	elseif horizontal &gt; 0 then
		roleImage.sprite = roleRes["RIGHT"][roleAnm]
	elseif verticla &gt; 0 then
		roleImage.sprite = roleRes["UP"][roleAnm]
	elseif verticla &lt; 0 then
		roleImage.sprite = roleRes["DOWN"][roleAnm]
	end
	--步伐（动画索引）
	if Time.time - lastAnmTime &gt; 0.1 then
		roleAnm = roleAnm+1
		if roleAnm &gt; 3 then roleAnm = 1 end
		lastAnmTime = Time.time
	end
	
end
</span></code></pre>
</div>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">运行游戏，玩家可以通过键盘的方向键控制角色移动。</span></p>
<img src="./LuaFramework 实战 - 田树东 - 博客园_files/v2-59f762a794af61130e09a6cfcb6130e0_hd.jpg" class="origin_image zh-lightbox-thumb lazy" width="593" alt="" style="overflow: hidden; display: block; max-width: 100%; margin: 0px auto">
<h2 style="margin: 20px 0px; font-weight: 400; line-height: inherit; color: rgb(51,51,51)">
<span style="font-size: 12px">3、编写射击代码</span></h2>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">在main.<b style="color:black;background-color:#ffff66">lua</b>中添加炮弹相关的变量，如下所示。其中bullet代表炮弹元件（panel.map.bullet），lastShootTime 代表上一次发射炮弹的时间，bulletSpeedX代表炮弹的水平移动速度，bulletSpeedY代表炮弹的垂直移动速度，roleFace代表角色的面向。然后在OnLoadFinish中给bullet赋值。</span></p>
<div class="highlight">
<pre style="margin-top: 1em; margin-bottom: 1em; padding: 10px; overflow: auto; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; background-color: rgb(246,246,246)"><code class="language-text" style="margin: 0px; padding: 0px; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace"><span style="font-size: 12px"><span></span>local bullet
local lastShootTime = -100
local bulletSpeedX = 0
local bulletSpeedY = 0
local roleFace = 0

function OnLoadFinish(objs)
	……
	--子弹元素
	bullet = map.transform:FindChild("bullet").gameObject
End
</span></code></pre>
</div>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">在Update中给roleFace赋值。</span></p>
<div class="highlight">
<pre style="margin-top: 1em; margin-bottom: 1em; padding: 10px; overflow: auto; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; background-color: rgb(246,246,246)"><code class="language-text" style="margin: 0px; padding: 0px; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace"><span style="font-size: 12px"><span></span>--每帧执行
function Update()
	
	--移动
	……
	--转向
	if horizontal &lt; 0 then
		roleImage.sprite = roleRes["LEFT"][roleAnm]
		roleFace = 1
	elseif horizontal &gt; 0 then
		roleImage.sprite = roleRes["RIGHT"][roleAnm]
		roleFace = 2
	elseif verticla &gt; 0 then
		roleImage.sprite = roleRes["UP"][roleAnm]
		roleFace = 3
	elseif verticla &lt; 0 then
		roleImage.sprite = roleRes["DOWN"][roleAnm]
		roleFace = 4
	end
	--步伐
	……
end
</span></code></pre>
</div>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">在Update中添加处理炮弹的代码，它处理如下几件事情。</span></p>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">1、炮弹在飞行1.2秒后，燃尽消失；</span></p>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">2、当玩家按下鼠标左键时，发射炮弹，根据角色面向，bulletSpeedX和bulletSpeedY会有不同的值。</span></p>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">3、根据bulletSpeedX和bulletSpeedY移动炮弹。</span></p>
<div class="highlight">
<pre style="margin-top: 1em; margin-bottom: 1em; padding: 10px; overflow: auto; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; background-color: rgb(246,246,246)"><code class="language-text" style="margin: 0px; padding: 0px; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace"><span style="font-size: 12px"><span></span>--每帧执行
function Update()
	……
	--子弹
	if Time.time - lastShootTime &gt; 1.2 then
		--消失
		if bullet.transform.position.x ~= -999 then
			bullet.transform.position = Vector3.New(-999,-999,0)
		end
		--发射
		if Input.GetMouseButton(0) then
			bullet.transform.position = Vector3.New(x,y,0)
			if roleFace == 1 then
				bulletSpeedX = -10
				bulletSpeedY = 0
			elseif roleFace == 2  then
				bulletSpeedX = 10
				bulletSpeedY = 0
			elseif roleFace == 3 then
				bulletSpeedX = 0
				bulletSpeedY = 10
			elseif roleFace == 4  then
				bulletSpeedX = 0
				bulletSpeedY = -10
			end
			lastShootTime = Time.time
		end
	else
		--运动
		local x = bullet.transform.position.x + bulletSpeedX
		local y = bullet.transform.position.y + bulletSpeedY
		bullet.transform.position = Vector3.New(x,y,0)
	end
end
</span></code></pre>
</div>
<p style="margin-top: 0px; margin-bottom: 20px; color: rgb(51,51,51)"><span style="font-size: 12px">运行游戏，点击鼠标左键，角色发射炮弹。另外也可以用基于组件的方法实现，这里就不展开了。</span></p>
<img src="./LuaFramework 实战 - 田树东 - 博客园_files/v2-5422ed5cf322a28e210b4e23f2998ac6_hd.jpg" class="origin_image zh-lightbox-thumb lazy" width="598" alt="" style="overflow: hidden; display: block; max-width: 100%; margin: 0px auto">
<p><span style="font-size: 12px"><br>
</span></p>
<p><span style="font-size: 12px"><br>
</span></p>
<br>
<p></p>
                </div>
                    </div><div id="MySignature"></div>
<div class="clear"></div>
<div id="blog_post_info_block">
<div id="BlogPostCategory"></div>
<div id="EntryTag"></div>
<div id="blog_post_info">
</div>
<div class="clear"></div>
<div id="post_next_prev"></div>
</div>


		</div>
		<div class="postDesc">posted @ <span id="post-date">2017-11-28 17:33</span> <a href="https://www.cnblogs.com/cxihu/">田树东</a> 阅读(<span id="post_view_count">...</span>) 评论(<span id="post_comment_count">...</span>)  <a href="https://i.cnblogs.com/EditPosts.aspx?postid=8465594" rel="nofollow">编辑</a> <a href="https://www.cnblogs.com/cxihu/p/8465594.html#" onclick="AddToWz(8465594);return false;">收藏</a></div>
	</div>
	

	
</div><!--end: topics 文章、评论容器-->
</div><a name="!comments"></a><div id="blog-comments-placeholder"></div>
<div id="comment_form" class="commentform">
<a name="commentform"></a>
<div id="divCommentShow"></div>
<div id="comment_nav"><span id="span_refresh_tips"></span><a href="javascript:void(0);" onclick="return RefreshCommentList();" id="lnk_RefreshComments" runat="server" clientidmode="Static">刷新评论</a><a href="https://www.cnblogs.com/cxihu/p/8465594.html#" onclick="return RefreshPage();">刷新页面</a><a href="https://www.cnblogs.com/cxihu/p/8465594.html#top">返回顶部</a></div>
<div id="comment_form_container"></div>
<div class="ad_text_commentbox" id="ad_text_under_commentbox"></div>
<div id="ad_t2"></div>
<div id="opt_under_post"></div>
<div id="cnblogs_c1" class="c_ad_block"></div>
<div id="under_post_news"></div>




<div id="cnblogs_c2" class="c_ad_block">
    <div id="div-gpt-ad-1539008685004-0" style="height:60px; width:468px;">
    
    </div>
</div>
<div id="under_post_kb"></div>
<div id="HistoryToday" class="c_ad_block"></div>

</div>


	</div><!--end: forFlow -->
	</div><!--end: mainContent 主体内容容器-->

	<div id="sideBar">
		<div id="sideBarMain">
			
<!--done-->
<div class="newsItem">
<h3 class="catListTitle">公告</h3>
	<div id="blog-news"></div>
</div>

			<div id="blog-calendar" style="display:none"></div>
			
			<div id="leftcontentcontainer">
				<div id="blog-sidecolumn"></div>
			</div>
			
		</div><!--end: sideBarMain -->
	</div><!--end: sideBar 侧边栏容器 -->
	<div class="clear"></div>
	</div><!--end: main -->
	<div class="clear"></div>
	<div id="footer">
		
<!--done-->
Copyright &#169;2018 田树东
	</div><!--end: footer -->
</div><!--end: home 自定义的最大容器 -->



</div>



</body></html>